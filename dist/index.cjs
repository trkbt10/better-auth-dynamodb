"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const ue=require("@better-auth/core/db/adapter"),Qe=require("node:crypto"),E=require("@aws-sdk/lib-dynamodb"),We=require("@better-auth/core/db"),F=require("@aws-sdk/client-dynamodb"),Ee={account:[{partitionKey:"providerId",sortKey:"accountId"}],session:[{partitionKey:"userId",sortKey:"createdAt"},{partitionKey:"token",sortKey:"createdAt"}],verification:[{partitionKey:"identifier",sortKey:"createdAt"}]},pe={deviceCode:{userId:{index:!0,references:{model:"user",field:"id"}}}},Je=(e,t)=>{const n=We.getAuthTables(e);return X(n,t)},X=(e,t)=>{const n=[],a=ze(t?.disableAutoCompositeIndexes?{}:Ee,t?.compositeIndexes??{}),i=Ye(t?.disableSchemaExtensions?{}:pe,t?.schemaExtensions??{});for(const[r,s]of Object.entries(e)){const o=s.modelName??r,l=[],m=[{AttributeName:"id",AttributeType:"S"}],c=[],u=new Set(["id"]),d=new Set,f=g=>{u.has(g)||(m.push({AttributeName:g,AttributeType:"S"}),u.add(g))},N=a[o]??[],h=new Set;for(const g of N){const x=g.partitionKey,S=g.sortKey,A=`${o}_${x}_${S}_idx`;d.has(A)||(f(x),f(S),c.push({IndexName:A,KeySchema:[{AttributeName:x,KeyType:"HASH"},{AttributeName:S,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}),l.push({indexName:A,partitionKey:x,sortKey:S}),d.add(A),h.add(x))}const v=t?.indexReferences!==!1,T=i[o]??{};for(const[g,x]of Object.entries(s.fields)){const S=x.fieldName??g,A=T[g],I=A?.index===!0?!0:x.index===!0,P=A?.unique===!0?!0:x.unique===!0,p=A?.references??x.references;if((I?!0:P)?!0:p!==void 0?v:!1){if(h.has(S))continue;const M=`${o}_${S}_idx`;if(d.has(M))continue;f(S),c.push({IndexName:M,KeySchema:[{AttributeName:S,KeyType:"HASH"}],Projection:{ProjectionType:"ALL"}}),l.push({indexName:M,partitionKey:S}),d.add(M)}}n.push({tableName:o,tableDefinition:{attributeDefinitions:m,keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:c.length>0?c:void 0},indexMappings:l})}return n},ze=(e,t)=>{const n={...e};for(const[a,i]of Object.entries(t))n[a]?n[a]=[...n[a],...i]:n[a]=i;return n},Ye=(e,t)=>{const n={};for(const[a,i]of Object.entries(e))n[a]={...i};for(const[a,i]of Object.entries(t))if(n[a])for(const[r,s]of Object.entries(i))n[a][r]={...n[a][r],...s};else n[a]={...i};return n},Xe=(e,t)=>t?e.map(n=>({...n,tableName:`${t}${n.tableName}`})):e,Ze=e=>{const t=X(e.tables,e.schemaOptions),n=e.file??"dynamodb-tables.ts",a=Xe(t,e.tableNamePrefix),i=JSON.stringify(a,null,2);return`/**
 * DynamoDB Table Schemas for Better Auth
 *
 * Generated by: npx @better-auth/cli generate
 * Run this script to create/update DynamoDB tables:
 *   npx ts-node ${n}
 */
import { DynamoDBClient } from "@aws-sdk/client-dynamodb";
import { applyTableSchemas } from "better-auth-dynamodb";
import type { TableSchema } from "better-auth-dynamodb";

const tableSchemas: TableSchema[] = ${i};

const client = new DynamoDBClient({});

await applyTableSchemas({ client, tables: tableSchemas });
console.log("DynamoDB tables created/updated successfully.");
`};class b extends Error{constructor(t,n){super(n),this.code=t,this.name="DynamoDBAdapterError"}}const ke=e=>e?e.toLowerCase():"eq",ce=e=>typeof e=="number"&&!Number.isNaN(e),D=e=>typeof e=="string",et=(e,t)=>e instanceof Date&&t instanceof Date?e.getTime()-t.getTime():ce(e)&&ce(t)?e-t:D(e)&&D(t)?e<t?-1:e>t?1:0:null,De=e=>Array.isArray(e)?e:[e],R=e=>{const t=e.appendValue(e.value);return`${e.fieldToken} ${e.operator} ${t}`},_=e=>{const t=et(e.fieldValue,e.value);return t===null?!1:e.operator==="gt"?t>0:e.operator==="gte"?t>=0:e.operator==="lt"?t<0:t<=0},de=e=>{const n=De(e.value).map(i=>e.appendValue(i)),a=`${e.fieldToken} IN (${n.join(", ")})`;return e.negate?`NOT (${a})`:a},me=e=>{const n=De(e.value).some(a=>a===e.fieldValue);return e.negate?!n:n},tt=e=>{const t=e.appendValue(e.value);return`contains(${e.fieldToken}, ${t})`},nt=e=>Array.isArray(e.fieldValue)||D(e.fieldValue)&&D(e.value)?e.fieldValue.includes(e.value):!1,at=e=>{const t=e.appendValue(e.value);return`begins_with(${e.fieldToken}, ${t})`},it=e=>D(e.fieldValue)&&D(e.value)?e.fieldValue.startsWith(e.value):!1,rt=e=>D(e.fieldValue)&&D(e.value)?e.fieldValue.endsWith(e.value):!1,st={eq:{requiresClientFilter:!1,buildFilterExpression:e=>{const t=e.appendValue(e.value);return`${e.fieldToken} = ${t}`},evaluate:e=>e.fieldValue===e.value},ne:{requiresClientFilter:!1,buildFilterExpression:e=>{const t=e.appendValue(e.value);return`${e.fieldToken} <> ${t}`},evaluate:e=>e.fieldValue!==e.value},gt:{requiresClientFilter:!1,buildFilterExpression:e=>R({fieldToken:e.fieldToken,value:e.value,operator:">",appendValue:e.appendValue}),evaluate:e=>_({fieldValue:e.fieldValue,value:e.value,operator:"gt"})},gte:{requiresClientFilter:!1,buildFilterExpression:e=>R({fieldToken:e.fieldToken,value:e.value,operator:">=",appendValue:e.appendValue}),evaluate:e=>_({fieldValue:e.fieldValue,value:e.value,operator:"gte"})},lt:{requiresClientFilter:!1,buildFilterExpression:e=>R({fieldToken:e.fieldToken,value:e.value,operator:"<",appendValue:e.appendValue}),evaluate:e=>_({fieldValue:e.fieldValue,value:e.value,operator:"lt"})},lte:{requiresClientFilter:!1,buildFilterExpression:e=>R({fieldToken:e.fieldToken,value:e.value,operator:"<=",appendValue:e.appendValue}),evaluate:e=>_({fieldValue:e.fieldValue,value:e.value,operator:"lte"})},in:{requiresClientFilter:!1,buildFilterExpression:e=>de({fieldToken:e.fieldToken,value:e.value,appendValue:e.appendValue,negate:!1}),evaluate:e=>me({fieldValue:e.fieldValue,value:e.value,negate:!1})},not_in:{requiresClientFilter:!1,buildFilterExpression:e=>de({fieldToken:e.fieldToken,value:e.value,appendValue:e.appendValue,negate:!0}),evaluate:e=>me({fieldValue:e.fieldValue,value:e.value,negate:!0})},contains:{requiresClientFilter:!1,buildFilterExpression:tt,evaluate:nt},starts_with:{requiresClientFilter:!1,buildFilterExpression:at,evaluate:it},ends_with:{requiresClientFilter:!0,buildFilterExpression:void 0,evaluate:rt}},Z=e=>{const t=ke(e),n=st[t];if(!n)throw new b("UNSUPPORTED_OPERATOR",`Unsupported operator: ${e}`);return n},Pe=e=>Z(e).requiresClientFilter,ee=e=>ke(e),Ke=e=>{if(!e)throw new b("MISSING_WHERE_INPUT","normalizeWhere requires explicit props.");const{where:t}=e;if(!t||t.length===0)return[];const n=a=>a&&a.toUpperCase()==="OR"?"OR":"AND";return t.map(a=>{const i=ee(a.operator),r=n(a.connector);return{field:a.field,operator:i,value:a.value,connector:r,requiresClientFilter:Pe(a.operator)}})},Me=e=>e.getFieldName({model:e.model,field:"id"}),fe=e=>e.where.find(t=>t.operator===e.operator&&t.field===e.primaryKeyName),ot=e=>{const t=r=>r?e.where.some(s=>s.operator==="eq"&&s.field===r):!1,n=r=>{if(e.indexKeySchemaResolver)return e.indexKeySchemaResolver({model:e.model,indexName:r})},i=e.where.filter(r=>r.operator==="eq").map(r=>{const s=e.indexNameResolver({model:e.model,field:r.field});if(!s)return null;const l=n(s)?.sortKey,m=t(l);return{entry:r,indexName:s,score:m?2:1}}).filter(r=>r!==null).reduce((r,s)=>!r||s.score>r.score?s:r,void 0);if(i)return{entry:i.entry,indexName:i.indexName}},lt=e=>{for(const t of e.where){if(t.operator!=="in"||!Array.isArray(t.value))continue;const n=e.indexNameResolver({model:e.model,field:t.field});if(n)return{entry:t,indexName:n}}},ut=e=>{if(!e)throw new b("MISSING_STRATEGY_INPUT","resolveBaseStrategy requires explicit props.");const t=e.where.filter(o=>o.connector==="AND"),n=Me({model:e.model,getFieldName:e.getFieldName});if(fe({where:t,primaryKeyName:n,operator:"eq"}))return{kind:"query",key:"pk"};const i=ot({where:t,model:e.model,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(i)return{kind:"query",key:"gsi",indexName:i.indexName};const r=lt({where:t,model:e.model,indexNameResolver:e.adapterConfig.indexNameResolver});if(r)return{kind:"multi-query",indexName:r.indexName,field:r.entry.field};const s=fe({where:t,primaryKeyName:n,operator:"in"});return s&&Array.isArray(s.value)?{kind:"batch-get"}:{kind:"scan"}},Fe=e=>{if(!e)throw new b("MISSING_JOIN_STRATEGY_INPUT","resolveJoinStrategyHint requires explicit props.");const t=Me({model:e.model,getFieldName:e.getFieldName});if(e.joinField===t)return{kind:"query",key:"pk"};const n=e.adapterConfig.indexNameResolver({model:e.model,field:e.joinField});return n?{kind:"query",key:"gsi",indexName:n}:{kind:"scan"}},ct=e=>{if(!e)throw new b("MISSING_JOIN_STRATEGY_INPUT","resolveJoinStrategy requires explicit props.");const t=Fe({joinField:e.joinField,model:e.model,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig});return t.kind==="query"&&t.key==="pk"&&e.baseValues.length>1?{kind:"batch-get"}:t},dt=e=>{if(!e)throw new b("MISSING_JOIN_PLAN_INPUT","resolveJoinPlan requires explicit props.");return!e.join||Object.keys(e.join).length===0?[]:Object.entries(e.join).map(([t,n])=>{const a=Fe({joinField:n.on.to,model:t,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig});return{modelKey:t,model:t,relation:n.relation??"one-to-many",on:n.on,limit:n.limit,select:void 0,strategy:a}})},mt=e=>{const t=e.where.some(a=>a.connector==="OR"),n=e.where.some(a=>a.requiresClientFilter);return{hasOrConnector:t,hasClientOnlyOperator:n,requiresSelectSupplement:e.requiresSelectSupplement}},ft=e=>{if(e.requiresClientFilter||e.requiresClientSort||e.limit===void 0)return;const t=e.offset??0;return e.limit+t},yt=e=>{if(e.sortBy)return{field:e.getFieldName({model:e.model,field:e.sortBy.field}),direction:e.sortBy.direction}},bt=e=>{if(!e.normalizedSort||e.baseStrategy.kind!=="query"||e.baseStrategy.key!=="gsi"||!e.baseStrategy.indexName||!e.adapterConfig.indexKeySchemaResolver)return;const t=e.adapterConfig.indexKeySchemaResolver({model:e.model,indexName:e.baseStrategy.indexName});if(!(!t||!t.sortKey)&&t.sortKey===e.normalizedSort.field)return e.normalizedSort},Nt=e=>!(!e.normalizedSort||e.serverSort),xt=e=>{if(!e.select||e.select.length===0)return{select:e.select,requiresSelectSupplement:!1};if(e.joins.length===0)return{select:[...e.select],requiresSelectSupplement:!1};const t={select:[...e.select],selectedFields:new Set(e.select.map(a=>e.getFieldName({model:e.model,field:a}))),requiresSelectSupplement:!1},n=e.joins.reduce((a,i)=>a.selectedFields.has(i.on.from)?a:(a.selectedFields.add(i.on.from),a.select.push(i.on.from),{...a,requiresSelectSupplement:!0}),t);return{select:n.select,requiresSelectSupplement:n.requiresSelectSupplement}},V=e=>{if(!e)throw new b("MISSING_QUERY_PLAN_INPUT","buildQueryPlan requires explicit props.");const t=Ke({where:e.where}),n=dt({join:e.join,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig}),a=xt({select:e.select,joins:n,getFieldName:e.getFieldName,model:e.model}),i=mt({where:t,requiresSelectSupplement:a.requiresSelectSupplement}),r=ut({model:e.model,where:t,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig}),s=n.reduce((d,f)=>(d[f.modelKey]=f.strategy,d),{}),o=i.hasClientOnlyOperator,l=yt({sortBy:e.sortBy,getFieldName:e.getFieldName,model:e.model}),m=bt({model:e.model,baseStrategy:r,normalizedSort:l,adapterConfig:e.adapterConfig}),c=Nt({normalizedSort:l,serverSort:m}),u={baseStrategy:r,joinStrategies:s,requiresClientFilter:o,requiresClientSort:c,serverSort:m,fetchLimit:ft({limit:e.limit,offset:e.offset,requiresClientFilter:o,requiresClientSort:c})};return{base:{model:e.model,where:t,select:a.select,sort:l,limit:e.limit,offset:e.offset},joins:n,execution:u,constraints:i}},ye=e=>{const t=Z(e.condition.operator),n=e.item[e.condition.fieldName];return t.evaluate({fieldValue:n,value:e.condition.value})},gt=e=>e.map(t=>({fieldName:t.field,operator:ee(t.operator),value:t.value,connector:t.connector})),ht=e=>{const{item:t,conditions:n}=e;if(n.length===0)return!0;const a=n.filter(u=>u.connector==="AND"),i=n.filter(u=>u.connector==="OR"),r=a.map(u=>ye({item:t,condition:u})),s=i.map(u=>ye({item:t,condition:u})),o=u=>u.length===0?!0:u.every(Boolean),l=u=>u.length===0?!0:u.some(Boolean);return!(!o(r)||!l(s))},Oe=e=>{if(!e.where||e.where.length===0)return e.items;const t=gt(e.where);return e.items.filter(n=>ht({item:n,conditions:t}))},St=e=>e.requiresClientFilter?Oe({items:e.items,where:e.where}):e.items,vt=e=>e==="desc"?-1:1,At=(e,t)=>{if(e.length<=1)return e;const n=vt(t.direction),a=i=>i==null;return[...e].sort((i,r)=>{const s=i[t.field],o=r[t.field];return s===o?0:a(s)?1*n:a(o)?-1*n:s>o?1*n:s<o?-1*n:0})},Ct=(e,t)=>t.sortBy?At(e,{field:t.sortBy.field,direction:t.sortBy.direction}):e,Tt=e=>{if(!e.select||e.select.length===0)return e.items;const t=e.select.map(n=>e.getFieldName({model:e.model,field:n}));return e.items.map(n=>{const a=t.reduce((r,s)=>(s in n&&(r[s]=n[s]),r),{}),i=e.joinKeys.reduce((r,s)=>(s in n&&(r[s]=n[s]),r),{});return{...a,...i}})},w=e=>{const{model:t,getDefaultModelName:n,config:a}=e,i=n(t);if(a.tableNameResolver)return a.tableNameResolver(i);if(a.tableNamePrefix!==void 0)return`${a.tableNamePrefix}${i}`;throw new b("MISSING_TABLE_RESOLVER","DynamoDB adapter requires tableNameResolver or tableNamePrefix.")},It=(e,t,n)=>{const a=`:v${t.index}`;return t.index+=1,n[a]=e,a},wt=e=>e&&e.toUpperCase()==="OR"?"OR":"AND",Et=e=>{for(const t of e)if(Pe(t.operator))return!0;return!1},pt=e=>{const t=Z(e.operator);if(!t.buildFilterExpression)throw new b("UNSUPPORTED_OPERATOR","Filter expression builder is missing.");const n={fieldToken:e.fieldToken,value:e.value,appendValue:a=>It(a,e.state,e.values)};return t.buildFilterExpression(n)},kt=e=>{const{andExpressions:t,orExpressions:n}=e,a=t.join(" AND "),i=n.join(" OR ");if(a&&i)return`(${a}) AND (${i})`;if(a)return a;if(i)return i},K=e=>{const{where:t,model:n,getFieldName:a}=e;if(!t||t.length===0)return{filterExpression:void 0,expressionAttributeNames:{},expressionAttributeValues:{},requiresClientFilter:!1};if(Et(t))return{filterExpression:void 0,expressionAttributeNames:{},expressionAttributeValues:{},requiresClientFilter:!0};const i={},r={},s={index:0},o=t.map((u,d)=>{const f=a({model:n,field:u.field}),N=`#f${d}`;i[N]=f;const h=pt({fieldToken:N,operator:u.operator,value:u.value,state:s,values:r});return{connector:wt(u.connector),expression:h}}),l=o.filter(u=>u.connector==="AND").map(u=>u.expression),m=o.filter(u=>u.connector==="OR").map(u=>u.expression);return{filterExpression:kt({andExpressions:l,orExpressions:m}),expressionAttributeNames:i,expressionAttributeValues:r,requiresClientFilter:!1}},L=e=>{const{model:t,where:n,getFieldName:a,indexNameResolver:i,indexKeySchemaResolver:r}=e;if(!n||n.length===0)return null;const s=a({model:t,field:"id"}),o=y=>y&&y.toUpperCase()==="OR"?"OR":"AND",l=n.map(y=>({entry:y,operator:ee(y.operator),fieldName:a({model:t,field:y.field}),connector:o(y.connector)})),m=l.find(({operator:y,fieldName:C,connector:k})=>y==="eq"&&k==="AND"&&C===s);if(m){const y=n.filter(C=>C!==m.entry);return{keyConditionExpression:"#pk = :pk",expressionAttributeNames:{"#pk":s},expressionAttributeValues:{":pk":m.entry.value},remainingWhere:y}}const c=y=>y?l.some(C=>C.connector!=="AND"||C.operator!=="eq"?!1:C.fieldName===y):!1,u=y=>{if(r)return r({model:t,indexName:y})},N=l.filter(y=>y.connector!=="AND"||y.operator!=="eq"?!1:!!i({model:t,field:y.entry.field})).map(y=>{const C=i({model:t,field:y.entry.field});if(!C)return null;const G=u(C)?.sortKey,He=c(G);return{candidate:y,indexName:C,score:He?2:1}}).filter(y=>y!==null).reduce((C,k)=>!C||k.score>C.score?k:C,void 0);if(!N)return null;const h=N.indexName,v=N.candidate,T=()=>{if(r)return r({model:t,indexName:h})},g=y=>{if(y)return l.find(({operator:C,fieldName:k,connector:G})=>C==="eq"&&G==="AND"&&k===y)},x=y=>y?"#pk = :pk AND #sk = :sk":"#pk = :pk",S=y=>y.sortKey?{"#pk":y.partitionKey,"#sk":y.sortKey}:{"#pk":y.partitionKey},A=y=>y.sortValue===void 0?{":pk":y.partitionValue}:{":pk":y.partitionValue,":sk":y.sortValue},P=T()?.sortKey,p=g(P),$=y=>{if(y)return P},se=y=>{if(y)return y.entry.value},oe=n.filter(y=>y!==v.entry&&y!==p?.entry),le=x(!!p),M=S({partitionKey:v.fieldName,sortKey:$(p)}),Ue=A({partitionValue:v.entry.value,sortValue:se(p)});return{keyConditionExpression:le,expressionAttributeNames:M,expressionAttributeValues:Ue,indexName:h,remainingWhere:oe}},j=(e,t)=>{t.filterExpression&&(e.FilterExpression=t.filterExpression),Object.keys(t.expressionAttributeNames).length>0&&(e.ExpressionAttributeNames=t.expressionAttributeNames),Object.keys(t.expressionAttributeValues).length>0&&(e.ExpressionAttributeValues=t.expressionAttributeValues)},B=async e=>{const t={token:e.initialToken,pageCount:0};for(;;){e.maxPages!==void 0&&t.pageCount>=e.maxPages&&e.onMaxPages(),t.pageCount+=1;const n=await e.fetchPage(t.token,t.pageCount),a=n.nextToken,i=n.shouldStop===!0;if(t.token=a,i||!t.token)break}},$e=(e,t)=>{if(e===void 0)return;const n=e-t;return n<=0?0:n},J=async e=>{const t=[],n={pages:0};if(await B({fetchPage:async a=>{n.pages+=1;const i=$e(e.limit,t.length);if(i===0)return{shouldStop:!0};const r={TableName:e.tableName,KeyConditionExpression:e.keyConditionExpression};e.indexName&&(r.IndexName=e.indexName),j(r,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),a&&(r.ExclusiveStartKey=a),i!==void 0&&(r.Limit=i),e.scanIndexForward!==void 0&&(r.ScanIndexForward=e.scanIndexForward);const s=await e.documentClient.send(new E.QueryCommand(r)),o=s.Items??[];return t.push(...o),e.operationStats?.recordQuery({tableName:e.tableName,items:o.length}),{nextToken:s.LastEvaluatedKey??void 0}}}),e.explainDynamoOperations){const a=e.limit===void 0?"∞":String(e.limit),i=e.filterExpression?"yes":"no",r=e.indexName??"(primary)";console.log(`DDB-OP QUERY table=${e.tableName} index=${r} pages=${n.pages} items=${t.length} limit=${a} filter=${i}`)}return t},Dt=async e=>{const t={count:0},n={pages:0};if(await B({fetchPage:async a=>{n.pages+=1;const i={TableName:e.tableName,KeyConditionExpression:e.keyConditionExpression,Select:"COUNT"};e.indexName&&(i.IndexName=e.indexName),j(i,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),a&&(i.ExclusiveStartKey=a);const r=await e.documentClient.send(new E.QueryCommand(i)),s=r.Count??0;return t.count+=s,e.operationStats?.recordQuery({tableName:e.tableName,items:s}),{nextToken:r.LastEvaluatedKey??void 0}}}),e.explainDynamoOperations){const a=e.filterExpression?"yes":"no",i=e.indexName??"(primary)";console.log(`DDB-OP QUERY-COUNT table=${e.tableName} index=${i} pages=${n.pages} count=${t.count} filter=${a}`)}return t.count},Ve=async e=>{const t=[],n={pages:0};if(await B({maxPages:e.maxPages??Number.POSITIVE_INFINITY,onMaxPages:()=>{throw new b("SCAN_PAGE_LIMIT","Scan exceeded the configured page limit.")},fetchPage:async a=>{n.pages+=1;const i=$e(e.limit,t.length);if(i===0)return{shouldStop:!0};const r={TableName:e.tableName};j(r,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),a&&(r.ExclusiveStartKey=a),i!==void 0&&(r.Limit=i);const s=await e.documentClient.send(new E.ScanCommand(r)),o=s.Items??[];return t.push(...o),e.operationStats?.recordScan({tableName:e.tableName,items:o.length}),{nextToken:s.LastEvaluatedKey??void 0}}}),e.explainDynamoOperations){const a=e.maxPages===void 0?"∞":String(e.maxPages),i=e.limit===void 0?"∞":String(e.limit),r=e.filterExpression?"yes":"no";console.log(`DDB-OP SCAN table=${e.tableName} pages=${n.pages} items=${t.length} limit=${i} maxPages=${a} filter=${r}`)}return t},Pt=async e=>{const t={count:0},n={pages:0};if(await B({maxPages:e.maxPages??Number.POSITIVE_INFINITY,onMaxPages:()=>{throw new b("SCAN_PAGE_LIMIT","Scan exceeded the configured page limit.")},fetchPage:async a=>{n.pages+=1;const i={TableName:e.tableName,Select:"COUNT"};j(i,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),a&&(i.ExclusiveStartKey=a);const r=await e.documentClient.send(new E.ScanCommand(i)),s=r.Count??0;return t.count+=s,e.operationStats?.recordScan({tableName:e.tableName,items:s}),{nextToken:r.LastEvaluatedKey??void 0}}}),e.explainDynamoOperations){const a=e.maxPages===void 0?"∞":String(e.maxPages),i=e.filterExpression?"yes":"no";console.log(`DDB-OP SCAN-COUNT table=${e.tableName} pages=${n.pages} count=${t.count} maxPages=${a} filter=${i}`)}return t.count},Kt=(e,t)=>{const n=Math.ceil(e.length/t);return Array.from({length:n},(a,i)=>e.slice(i*t,(i+1)*t))},Mt=(e,t)=>t.map(n=>({[e]:n})),Ft=e=>{const t=e.unprocessed?.[e.tableName]?.Keys;return t||[]},te=async e=>{if(e.keys.length===0)return[];const t=e.maxAttempts??5;if(t<=0)throw new b("INVALID_BATCH_GET_ATTEMPTS","BatchGet requires maxAttempts > 0.");const n=e.backoffBaseDelayMs??10,a=e.backoffMaxDelayMs??200;if(n<0||a<0)throw new b("INVALID_BATCH_GET_BACKOFF","BatchGet backoff delays must be >= 0.");const i=[],r=Kt(e.keys,100),s={requests:0,retries:0},o=async d=>{d<=0||await new Promise(f=>{setTimeout(()=>f(),d)})},l=d=>{if(d<=0)return 0;const f=n*Math.pow(2,d-1);return Math.min(a,f)},m=d=>{if(typeof d!="object"||d===null)return;const f=d;if(typeof f.name=="string")return f.name;if(typeof f.code=="string")return f.code},c=d=>{const f=m(d);return f?new Set(["ProvisionedThroughputExceededException","ThrottlingException","RequestLimitExceeded","TooManyRequestsException","InternalServerError","ServiceUnavailable"]).has(f):!1},u=async(d,f)=>{if(d.length===0)return[];if(f>=t)throw new b("BATCH_GET_UNPROCESSED","Failed to resolve unprocessed keys after retries.");const N=async(x,S)=>{s.requests+=1,S>0&&(s.retries+=1);try{return await e.documentClient.send(new E.BatchGetCommand({RequestItems:{[e.tableName]:{Keys:x}}}))}catch(A){if(e.operationStats?.recordBatchGet({tableName:e.tableName,keys:x.length,items:0,isRetry:S>0}),!c(A))throw A;const I=S+1;if(I>=t)throw A;return await o(l(I)),N(x,I)}},v=await N(d,f),T=v.Responses?.[e.tableName]??[];e.operationStats?.recordBatchGet({tableName:e.tableName,keys:d.length,items:T.length,isRetry:f>0});const g=Ft({unprocessed:v.UnprocessedKeys,tableName:e.tableName});if(g.length>0){const x=f+1;if(x>=t)throw new b("BATCH_GET_UNPROCESSED","Failed to resolve unprocessed keys after retries.");await o(l(x));const S=await u(g,x);return[...T,...S]}return T};for(const d of r){const f=Mt(e.keyField,d),N=await u(f,0);i.push(...N)}if(e.explainDynamoOperations){const d=Math.ceil(e.keys.length/100);console.log(`DDB-OP BATCH-GET table=${e.tableName} key=${e.keyField} keys=${e.keys.length} chunks=${d} requests=${s.requests} retries=${s.retries} items=${i.length}`)}return i},Ot=e=>e.relation==="one-to-one"?1:e.limit!==void 0?e.limit:100,$t=e=>{if(!(e.baseValues.length>1))return e.limit},Vt=e=>{if(e.adapterConfig.scanPageLimitMode==="unbounded")return Number.POSITIVE_INFINITY;if(e.adapterConfig.scanMaxPages===void 0)throw new b("MISSING_SCAN_LIMIT","Join scan requires scanMaxPages.");return e.adapterConfig.scanMaxPages},Rt=e=>{const t=e.items.map(n=>n[e.field]).filter(n=>n!==void 0);return Array.from(new Set(t))},_t=e=>{const t=new Map;for(const n of e.items){const a=n[e.field];if(a===void 0)continue;const i=t.get(a)??[];t.set(a,[...i,n])}return t},qt=e=>e==="one-to-one"?null:[],Lt=(e,t)=>t===void 0?[]:e.get(t)??[],be=e=>[{field:e.field,operator:e.operator,value:e.value,connector:"AND"}],jt=async e=>{const t=w({model:e.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),n=L({model:e.model,where:e.where,getFieldName:e.getFieldName,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(!n)throw new b("MISSING_KEY_CONDITION","Join query requires a key condition.");const a=K({model:e.model,where:n.remainingWhere,getFieldName:e.getFieldName});return await J({documentClient:e.documentClient,tableName:t,indexName:n.indexName,keyConditionExpression:n.keyConditionExpression,filterExpression:a.filterExpression,expressionAttributeNames:{...n.expressionAttributeNames,...a.expressionAttributeNames},expressionAttributeValues:{...n.expressionAttributeValues,...a.expressionAttributeValues},limit:e.limit,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})},Bt=async e=>{const t=w({model:e.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),n=K({model:e.model,where:e.where,getFieldName:e.getFieldName});return await Ve({documentClient:e.documentClient,tableName:t,filterExpression:n.filterExpression,expressionAttributeNames:n.expressionAttributeNames,expressionAttributeValues:n.expressionAttributeValues,limit:e.limit,maxPages:e.maxPages,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})},Gt=async e=>{if(!e)throw new b("MISSING_JOIN_EXECUTION_INPUT","executeJoin requires explicit props.");const t=Rt({items:e.baseItems,field:e.join.on.from});if(t.length===0)return e.baseItems.map(l=>({...l,[e.join.modelKey]:qt(e.join.relation)}));const n=ct({joinField:e.join.on.to,model:e.join.model,baseValues:t,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig}),a=Ot({relation:e.join.relation,limit:e.join.limit}),r=await(async()=>{if(n.kind==="batch-get"){const u=e.join.on.to;return te({documentClient:e.documentClient,tableName:w({model:e.join.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),keyField:u,keys:t,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})}if(n.kind==="query"){const u=Promise.resolve([]);return t.reduce(async(d,f)=>{const N=await d,h=be({field:e.join.on.to,operator:"eq",value:f}),v=await jt({documentClient:e.documentClient,adapterConfig:e.adapterConfig,model:e.join.model,where:h,limit:a,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName,operationStats:e.operationStats});return[...N,...v]},u)}const l=be({field:e.join.on.to,operator:"in",value:t}),m=Vt({adapterConfig:e.adapterConfig}),c=$t({limit:a,baseValues:t});return Bt({documentClient:e.documentClient,adapterConfig:e.adapterConfig,model:e.join.model,where:l,limit:c,maxPages:m,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName,operationStats:e.operationStats})})(),s=_t({items:r,field:e.join.on.to}),o=l=>e.join.relation==="one-to-one"?l[0]??null:l.slice(0,a);return e.baseItems.map(l=>{const m=l[e.join.on.from],c=Lt(s,m),u=o(c);return{...l,[e.join.modelKey]:u}})},Ut=e=>e.strategy.kind==="batch-get"?!0:e.requiresClientFilter,Ht=e=>{if(e.serverSort)return e.serverSort.direction==="asc"},Qt=e=>e.strategy.kind!=="query"?e.keyConditionIndex:e.strategy.key==="gsi"?e.strategy.indexName:e.keyConditionIndex,Wt=e=>e.serverSort?e.items:Ct(e.items,{sortBy:e.sort}),Jt=e=>{if(e.adapterConfig.scanPageLimitMode==="unbounded")return Number.POSITIVE_INFINITY;if(e.adapterConfig.scanMaxPages===void 0)throw new b("MISSING_SCAN_LIMIT","Scan execution requires scanMaxPages.");return e.adapterConfig.scanMaxPages},zt=e=>e.map(t=>({field:t.field,operator:t.operator,value:t.value,connector:t.connector})),Yt=e=>{const t=e.where.find(n=>n.field===e.primaryKeyName&&n.operator==="in");return t?Array.isArray(t.value)?t.value:[]:[]},Xt=async e=>{const t=zt(e.plan.base.where),n=w({model:e.plan.base.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),a=e.plan.execution.baseStrategy;if(a.kind==="batch-get"){const s=e.getFieldName({model:e.plan.base.model,field:"id"}),o=Yt({where:e.plan.base.where,primaryKeyName:s});return o.length===0?[]:te({documentClient:e.documentClient,tableName:n,keyField:s,keys:o,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})}if(a.kind==="multi-query"){const s=e.plan.base.where.find(u=>u.field===a.field&&u.operator==="in");if(!s)return[];if(!Array.isArray(s.value))return[];const o=s.value,l=e.plan.execution.fetchLimit,m=e.plan.base.model;return(await Promise.all(o.map(async u=>{const d=t.map(h=>h.field===a.field&&h.operator==="in"?{...h,operator:"eq",value:u}:h),f=L({model:m,where:d,getFieldName:e.getFieldName,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(!f)return[];const N=K({model:m,where:f.remainingWhere,getFieldName:e.getFieldName});return await J({documentClient:e.documentClient,tableName:n,indexName:f.indexName??a.indexName,keyConditionExpression:f.keyConditionExpression,filterExpression:N.filterExpression,expressionAttributeNames:{...f.expressionAttributeNames,...N.expressionAttributeNames},expressionAttributeValues:{...f.expressionAttributeValues,...N.expressionAttributeValues},limit:l,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})}))).flat()}if(a.kind==="query"){const s=L({model:e.plan.base.model,where:t,getFieldName:e.getFieldName,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(!s)throw new b("MISSING_KEY_CONDITION","Query strategy requires a key condition.");const o=K({model:e.plan.base.model,where:s.remainingWhere,getFieldName:e.getFieldName}),l=Qt({strategy:a,keyConditionIndex:s.indexName}),m=Ht({serverSort:e.plan.execution.serverSort});return await J({documentClient:e.documentClient,tableName:n,indexName:l,keyConditionExpression:s.keyConditionExpression,filterExpression:o.filterExpression,expressionAttributeNames:{...s.expressionAttributeNames,...o.expressionAttributeNames},expressionAttributeValues:{...s.expressionAttributeValues,...o.expressionAttributeValues},limit:e.plan.execution.fetchLimit,scanIndexForward:m,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})}const i=K({model:e.plan.base.model,where:t,getFieldName:e.getFieldName}),r=Jt({adapterConfig:e.adapterConfig});return await Ve({documentClient:e.documentClient,tableName:n,filterExpression:i.filterExpression,expressionAttributeNames:i.expressionAttributeNames,expressionAttributeValues:i.expressionAttributeValues,limit:e.plan.execution.fetchLimit,maxPages:r,explainDynamoOperations:e.adapterConfig.explainDynamoOperations,operationStats:e.operationStats})},Zt=e=>{const t=e.offset??0;return e.limit===void 0?e.items.slice(t):e.items.slice(t,t+e.limit)},O=e=>{if(!e)throw new b("MISSING_EXECUTOR_INPUT","createQueryPlanExecutor requires explicit props.");return async(t,n)=>{const a=await Xt({plan:t,documentClient:e.documentClient,adapterConfig:e.adapterConfig,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName,operationStats:n?.operationStats}),i=Ut({strategy:t.execution.baseStrategy,requiresClientFilter:t.execution.requiresClientFilter}),r=St({items:a,where:t.base.where,requiresClientFilter:i}),s=Wt({items:r,serverSort:t.execution.serverSort,sort:t.base.sort}),o=Zt({items:s,offset:t.base.offset,limit:t.base.limit}),m=await t.joins.reduce(async(d,f)=>{const N=await d;return Gt({baseItems:N,join:f,documentClient:e.documentClient,adapterConfig:e.adapterConfig,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName,operationStats:n?.operationStats})},Promise.resolve(o)),c=t.joins.map(d=>d.modelKey);return Tt({items:m,model:t.base.model,select:t.base.select,joinKeys:c,getFieldName:e.getFieldName})}},en=()=>">=1",tn=e=>e===void 0?"unknown":Number.isFinite(e)?`<=${e}`:"unbounded",nn=e=>typeof e=="string"||typeof e=="number"||typeof e=="boolean"||e===null?JSON.stringify(e):Array.isArray(e)?`[${e.map(t=>JSON.stringify(t)).join(", ")}]`:"…",an=e=>`${e.connector} ${e.field} ${e.operator} ${nn(e.value)}`,U=e=>e===void 0?"∞":String(e),Ne=e=>e.kind==="query"?e.key==="pk"?"query(pk)":`query(gsi:${e.indexName??"?"})`:e.kind==="multi-query"?`multi-query(gsi:${e.indexName})`:e.kind==="batch-get"?"batch-get(pk)":"scan",q=(e,t)=>{const n="  ".repeat(t);return e.map(a=>`${n}${a}`)},xe=e=>{const t=e.where.find(n=>n.operator!=="in"||!Array.isArray(n.value)?!1:e.field===void 0?!0:n.field===e.field);if(t&&Array.isArray(t.value))return t.value.length},rn=e=>{const t=e.plan.execution.baseStrategy;if(t.kind==="scan")return e.adapterConfig.scanPageLimitMode==="unbounded"?"ScanCommand: unbounded":`ScanCommand: ${tn(e.adapterConfig.scanMaxPages)}`;if(t.kind==="query")return`QueryCommand: ${en()}`;if(t.kind==="multi-query"){const n=xe({where:e.plan.base.where,field:t.field});return n===void 0?"QueryCommand: unknown":`QueryCommand: =${n}`}if(t.kind==="batch-get"){const n=xe({where:e.plan.base.where});return n===void 0?"BatchGetCommand: unknown":`BatchGetCommand: =${Math.ceil(n/100)} (chunks=${Math.ceil(n/100)})`}return"unknown"},sn=e=>{const t=e.plan,n=w({model:t.base.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),a=[],i=Ne(t.execution.baseStrategy).toUpperCase(),r=U(t.execution.fetchLimit),o=t.execution.baseStrategy.kind!=="scan"?"n/a":U(e.adapterConfig.scanMaxPages);a.push(`-> ${i} table=${n} fetchLimit=${r} scanMaxPages=${o} scanPageLimitMode=${e.adapterConfig.scanPageLimitMode}`),a.push(`   est: ${rn({plan:t,adapterConfig:e.adapterConfig})}`),(t.constraints.hasOrConnector||t.constraints.hasClientOnlyOperator)&&a.push(`-> FILTER (client) or=${t.constraints.hasOrConnector} clientOnly=${t.constraints.hasClientOnlyOperator}`),t.execution.requiresClientSort&&a.push("-> SORT (client)"),(t.base.offset!==void 0||t.base.limit!==void 0)&&a.push(`-> LIMIT offset=${t.base.offset??0} limit=${U(t.base.limit)}`);const l=t.joins.reduce((m,c)=>{const u=w({model:c.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),d=Ne(c.strategy),f=[];return f.push(`-> JOIN ${c.modelKey} relation=${c.relation} on ${c.on.from} = ${c.on.to} strategy=${d} table=${u}`),d==="query(pk)"&&f.push("   note: uses BATCH-GET when >1 distinct key"),[...f,...q(m,1)]},a);return t.base.select&&t.base.select.length>0?[`-> PROJECT (${t.base.select.join(", ")})`,...q(l,1)]:["-> PROJECT (*)",...q(l,1)]},ne=e=>{const t=[];t.push("EXPLAIN DynamoDBAdapter"),t.push(`QUERY model=${e.plan.base.model}`);const n=e.plan.base.where.map(a=>an(a));if(n.length>0){t.push("WHERE");for(const a of n)t.push(`  ${a}`)}else t.push("WHERE (none)");return t.push("PLAN"),t.push(...q(sn(e),1)),t.join(`
`)},H=(e,t)=>{const n=e[t.tableName];if(n)return n;const a=t.makeInitial();return e[t.tableName]=a,a},ae=()=>{const e={totals:{scanCommands:0,queryCommands:0,batchGetCommands:0},scans:{},queries:{},batchGets:{}};return{recordScan:t=>{e.totals.scanCommands+=1;const n=H(e.scans,{tableName:t.tableName,makeInitial:()=>({commands:0,items:0})});n.commands+=1,n.items+=t.items},recordQuery:t=>{e.totals.queryCommands+=1;const n=H(e.queries,{tableName:t.tableName,makeInitial:()=>({commands:0,items:0})});n.commands+=1,n.items+=t.items},recordBatchGet:t=>{e.totals.batchGetCommands+=1;const n=H(e.batchGets,{tableName:t.tableName,makeInitial:()=>({commands:0,keys:0,retries:0,items:0})});n.commands+=1,n.keys+=t.keys,n.items+=t.items,t.isRetry&&(n.retries+=1)},snapshot:()=>e}},Q=e=>Object.keys(e).sort((t,n)=>t.localeCompare(n)),ie=e=>{const t=[];t.push("ACTUAL"),t.push(`  commands: ScanCommand=${e.totals.scanCommands} QueryCommand=${e.totals.queryCommands} BatchGetCommand=${e.totals.batchGetCommands}`);for(const n of Q(e.scans)){const a=e.scans[n];t.push(`  SCAN table=${n} commands=${a.commands} items=${a.items}`)}for(const n of Q(e.queries)){const a=e.queries[n];t.push(`  QUERY table=${n} commands=${a.commands} items=${a.items}`)}for(const n of Q(e.batchGets)){const a=e.batchGets[n];t.push(`  BATCH-GET table=${n} commands=${a.commands} keys=${a.keys} retries=${a.retries} items=${a.items}`)}return t.join(`
`)},on=(e,t)=>{const{documentClient:n}=e,{adapterConfig:a,getFieldName:i,getDefaultModelName:r}=t,s=()=>{if(a.scanPageLimitMode==="unbounded")return Number.POSITIVE_INFINITY;if(a.scanMaxPages===void 0)throw new b("MISSING_SCAN_LIMIT","Count scan requires scanMaxPages.");return a.scanMaxPages};return async({model:o,where:l})=>{const c=(()=>{if(a.explainQueryPlans)return ae()})(),u=g=>(a.explainQueryPlans&&c&&console.log(ie(c.snapshot())),g),d=V({model:o,where:l,select:void 0,sortBy:void 0,limit:void 0,offset:void 0,join:void 0,getFieldName:i,adapterConfig:a});if(a.explainQueryPlans&&console.log(ne({plan:d,adapterConfig:a,getDefaultModelName:r})),d.execution.requiresClientFilter){const x=await O({documentClient:n,adapterConfig:a,getFieldName:i,getDefaultModelName:r})(d,{operationStats:c});return u(x.length)}if(d.execution.baseStrategy.kind==="batch-get"){const x=await O({documentClient:n,adapterConfig:a,getFieldName:i,getDefaultModelName:r})(d,{operationStats:c});return u(x.length)}const f=w({model:o,getDefaultModelName:r,config:a}),N=d.base.where.map(g=>({field:g.field,operator:g.operator,value:g.value,connector:g.connector}));if(d.execution.baseStrategy.kind==="query"){const g=L({model:o,where:N,getFieldName:i,indexNameResolver:a.indexNameResolver,indexKeySchemaResolver:a.indexKeySchemaResolver});if(!g)throw new b("MISSING_KEY_CONDITION","Count query requires a key condition.");const x=K({model:o,where:g.remainingWhere,getFieldName:i}),S=await Dt({documentClient:n,tableName:f,indexName:g.indexName,keyConditionExpression:g.keyConditionExpression,filterExpression:x.filterExpression,expressionAttributeNames:{...g.expressionAttributeNames,...x.expressionAttributeNames},expressionAttributeValues:{...g.expressionAttributeValues,...x.expressionAttributeValues},explainDynamoOperations:a.explainDynamoOperations,operationStats:c});return u(S)}const h=K({model:o,where:N,getFieldName:i}),v=s(),T=await Pt({documentClient:n,tableName:f,filterExpression:h.filterExpression,expressionAttributeNames:h.expressionAttributeNames,expressionAttributeValues:h.expressionAttributeValues,maxPages:v,explainDynamoOperations:a.explainDynamoOperations,operationStats:c});return u(T)}},ln=()=>({operations:[]}),re=(e,t)=>{if(e.operations.length>=25)throw new b("TRANSACTION_LIMIT","DynamoDB transactions are limited to 25 operations.");e.operations.push(t)},un=e=>e.kind==="put"?{Put:{TableName:e.tableName,Item:e.item}}:e.kind==="update"?{Update:{TableName:e.tableName,Key:e.key,UpdateExpression:e.updateExpression,ExpressionAttributeNames:e.expressionAttributeNames,ExpressionAttributeValues:e.expressionAttributeValues}}:{Delete:{TableName:e.tableName,Key:e.key}},cn=async e=>{const{documentClient:t,state:n}=e;if(n.operations.length===0)return;const a=n.operations.map(i=>un(i));await t.send(new E.TransactWriteCommand({TransactItems:a}))},dn=(e,t)=>{const{documentClient:n}=e,{adapterConfig:a,getDefaultModelName:i,transactionState:r}=t,s=o=>w({model:o,getDefaultModelName:i,config:a});return async({model:o,data:l})=>{const m=s(o);return r?(re(r,{kind:"put",tableName:m,item:l}),l):(await n.send(new E.PutCommand({TableName:m,Item:l})),l)}},Re=e=>{const{item:t,keyField:n}=e;if(!(n in t))throw new b("MISSING_PRIMARY_KEY",`Item is missing primary key field "${n}".`);return{[n]:t[n]}},_e=(e,t)=>{const{documentClient:n}=e,{adapterConfig:a,getFieldName:i,getDefaultModelName:r,transactionState:s}=t,o=O({documentClient:n,adapterConfig:a,getFieldName:i,getDefaultModelName:r}),l=c=>w({model:c,getDefaultModelName:r,config:a}),m=c=>i({model:c,field:"id"});return async({model:c,where:u,limit:d})=>{const f=l(c),N=V({model:c,where:u,select:void 0,sortBy:void 0,limit:d,offset:void 0,join:void 0,getFieldName:i,adapterConfig:a}),h=await o(N);if(h.length===0)return 0;const v=m(c),T={deleted:0};for(const g of h){const x=Re({item:g,keyField:v});s?re(s,{kind:"delete",tableName:f,key:x}):await n.send(new E.DeleteCommand({TableName:f,Key:x})),T.deleted+=1}return T.deleted}},mn=(e,t)=>{const n=_e(e,t);return async({model:a,where:i})=>n({model:a,where:i})},fn=(e,t)=>{const n=_e(e,t);return async({model:a,where:i})=>{await n({model:a,where:i,limit:1})}},yn=(e,t)=>{const{documentClient:n}=e,{adapterConfig:a,getFieldName:i,getDefaultModelName:r}=t,s=O({documentClient:n,adapterConfig:a,getFieldName:i,getDefaultModelName:r});return async({model:o,where:l,limit:m,sortBy:c,offset:u,join:d})=>{const f=V({model:o,where:l,select:void 0,sortBy:c,limit:m,offset:u,join:d,getFieldName:i,adapterConfig:a}),h=(()=>{if(a.explainQueryPlans)return ae()})();a.explainQueryPlans&&console.log(ne({plan:f,adapterConfig:a,getDefaultModelName:r}));const v=await s(f,{operationStats:h});return a.explainQueryPlans&&h&&console.log(ie(h.snapshot())),v}},bn=(e,t)=>{const n=yn(e,t);return async a=>await n(a)},Nn=e=>{const{transactionState:t,tableName:n,where:a}=e,i=t.operations.filter(o=>o.kind==="put"&&o.tableName===n).map(o=>o.item);if(i.length===0)return{found:!1};const r=Ke({where:a}),s=Oe({items:i,where:r});return s.length===0?{found:!1}:{found:!0,item:s[s.length-1]}},xn=(e,t)=>{const n=O({documentClient:e.documentClient,adapterConfig:t.adapterConfig,getFieldName:t.getFieldName,getDefaultModelName:t.getDefaultModelName});return async({model:a,where:i,select:r,join:s})=>{if(t.transactionState){const u=w({model:a,getDefaultModelName:t.getDefaultModelName,config:t.adapterConfig}),d=Nn({transactionState:t.transactionState,tableName:u,where:i});if(d.found)return d.item}if(t.primaryKeyLoader&&s===void 0&&r===void 0&&i.length===1){const u=i[0],d=u.operator??"eq",f=(u.connector??"AND").toUpperCase(),N=t.getFieldName({model:a,field:"id"});if(d==="eq"&&f==="AND"&&u.field===N){const h=u.value;return h===void 0?null:await t.primaryKeyLoader.load({model:a,key:h})??null}}const o=V({model:a,where:i,select:r,sortBy:void 0,limit:1,offset:0,join:s,getFieldName:t.getFieldName,adapterConfig:t.adapterConfig}),m=(()=>{if(t.adapterConfig.explainQueryPlans)return ae()})();t.adapterConfig.explainQueryPlans&&console.log(ne({plan:o,adapterConfig:t.adapterConfig,getDefaultModelName:t.getDefaultModelName}));const c=await n(o,{operationStats:m});return t.adapterConfig.explainQueryPlans&&m&&console.log(ie(m.snapshot())),c.length===0?null:c[0]}},ge=e=>e!==null&&typeof e=="object"&&!Array.isArray(e),z=(e,t,n)=>{if(Object.is(t,n))return[];if(typeof t!=typeof n)return[{path:e,prev:t,next:n}];if(Array.isArray(t)&&Array.isArray(n)){const a=Math.max(t.length,n.length);return Array.from({length:a},(i,r)=>{const s=t[r],o=n[r];return z([...e,r],s,o)}).flat()}if(ge(t)&&ge(n)){const a=new Set([...Object.keys(t),...Object.keys(n)]);return Array.from(a).flatMap(i=>z([...e,i],t[i],n[i]))}return[{path:e,prev:t,next:n}]},he=e=>{const t=new Map,n={value:0};return a=>{const i=t.get(a);if(i)return i;const r=`${e}${n.value}`;return n.value+=1,t.set(a,r),r}},gn=(e,t)=>typeof e<"u"&&typeof t>"u",hn=(e,t)=>typeof e=="number"&&typeof t=="number",Sn=(e,t)=>typeof e!=typeof t,vn=(e,t)=>typeof e==typeof t,Se=e=>{if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{throw new b("INVALID_UPDATE","Failed to serialize update value.")}},An=e=>{if(Object.is(e.prev,e.next))return{kind:"noop",expression:"",attributeNames:{},attributeValues:{}};const t=e.path.filter(o=>typeof o=="string"),n=t.map(o=>e.makeNameKey(o)),a=o=>o===""?"":".",i=e.path.reduce((o,l)=>{if(typeof l=="number")return`${o}[${l}]`;const m=a(o);return`${o}${m}#${e.makeNameKey(l)}`},""),r=n.map((o,l)=>[`#${o}`,t[l].toString()]),s=Object.fromEntries(r);if(gn(e.prev,e.next))return{kind:"remove",expression:i,attributeNames:s,attributeValues:{}};if(hn(e.prev,e.next)){const o=e.next-e.prev,l=e.makeValueKey(Se(o));return{kind:"add",expression:`${i} :${l}`,attributeNames:s,attributeValues:{[`:${l}`]:o}}}if(vn(e.prev,e.next)||Sn(e.prev,e.next)){const o=e.makeValueKey(Se(e.next));return{kind:"set",expression:`${i} = :${o}`,attributeNames:s,attributeValues:{[`:${o}`]:e.next}}}return{kind:"noop",expression:"",attributeNames:{},attributeValues:{}}},Cn=e=>{const t=e.reduce((a,i)=>{const r=a[i.kind]??[];return a[i.kind]=[...r,i],a},{}),n=Object.entries(t).reduce((a,[i,r])=>{if(i==="noop")return a;const s=r.map(o=>o.expression).join(",");return{updateExpression:[...a.updateExpression,`${i.toUpperCase()} ${s}`],attributeNames:r.reduce((o,l)=>({...o,...l.attributeNames}),a.attributeNames),attributeValues:r.reduce((o,l)=>({...o,...l.attributeValues}),a.attributeValues)}},{updateExpression:[],attributeNames:{},attributeValues:{}});return{updateExpression:n.updateExpression.join(" "),attributeNames:n.attributeNames,attributeValues:n.attributeValues}},Tn=e=>{if(!e)throw new b("INVALID_UPDATE","Patch update requires explicit prev/next.");const t=z([],e.prev,e.next);if(t.length===0)throw new b("INVALID_UPDATE","Update payload must include at least one defined value.");const n=he("a"),a=he("v"),i=t.map(s=>An({...s,makeNameKey:n,makeValueKey:a})),r=Cn(i);if(!r.updateExpression)throw new b("INVALID_UPDATE","Update payload must include at least one defined value.");return{updateExpression:r.updateExpression,expressionAttributeNames:r.attributeNames,expressionAttributeValues:r.attributeValues}},In=(e,t)=>Object.entries(t).reduce((n,[a,i])=>({...n,[a]:i}),{...e}),wn=e=>Object.entries(e).reduce((n,[a,i])=>i===void 0?n:{...n,[a]:i},{}),En=e=>e?{ReturnValues:"ALL_NEW"}:{},qe=(e,t)=>{const{documentClient:n}=e,{adapterConfig:a,getFieldName:i,getDefaultModelName:r,transactionState:s}=t,o=O({documentClient:n,adapterConfig:a,getFieldName:i,getDefaultModelName:r}),l=c=>w({model:c,getDefaultModelName:r,config:a}),m=c=>i({model:c,field:"id"});return async({model:c,where:u,update:d,limit:f,returnUpdatedItems:N})=>{const h=l(c),v=V({model:c,where:u,select:void 0,sortBy:void 0,limit:f,offset:void 0,join:void 0,getFieldName:i,adapterConfig:a}),T=await o(v);if(T.length===0)return{updatedCount:0,updatedItems:[]};const g=m(c),x={updatedCount:0,updatedItems:[]};for(const S of T){const A=In(S,d),I=Tn({prev:S,next:A}),P=Re({item:S,keyField:g});if(s)re(s,{kind:"update",tableName:h,key:P,updateExpression:I.updateExpression,expressionAttributeNames:I.expressionAttributeNames,expressionAttributeValues:I.expressionAttributeValues}),N&&x.updatedItems.push(wn(A));else{const p={TableName:h,Key:P,UpdateExpression:I.updateExpression,ExpressionAttributeNames:I.expressionAttributeNames,ExpressionAttributeValues:I.expressionAttributeValues,...En(N)},$=await n.send(new E.UpdateCommand(p));N&&$.Attributes&&x.updatedItems.push($.Attributes)}x.updatedCount+=1}return x}},pn=(e,t)=>{const n=qe(e,t);return async({model:a,where:i,update:r})=>(await n({model:a,where:i,update:r,returnUpdatedItems:!1})).updatedCount},kn=(e,t)=>{const n=qe(e,t);return async({model:a,where:i,update:r})=>{const s=await n({model:a,where:i,update:r,limit:1,returnUpdatedItems:!0});return s.updatedItems.length===0?null:s.updatedItems[0]}},ve=e=>String(e),Dn=e=>`${e.tableName}:${e.keyField}`,Pn=e=>{if(!e)throw new b("MISSING_EXECUTOR_INPUT","createPrimaryKeyBatchLoader requires explicit props.");const t=new Map,n=r=>{const s=w({model:r,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),o=e.getFieldName({model:r,field:"id"}),l=Dn({tableName:s,keyField:o}),m=t.get(l);if(m)return m;const c={model:r,keyField:o,tableName:s,scheduled:!1,pendingByToken:new Map};return t.set(l,c),c},a=async r=>{if(r.pendingByToken.size===0){r.scheduled=!1;return}const s=new Map(r.pendingByToken);r.pendingByToken.clear(),r.scheduled=!1;const o=Array.from(s.values()).map(l=>l.key);if(e.adapterConfig.explainQueryPlans){const l=Math.ceil(o.length/100);console.log(["EXPLAIN DynamoDBAdapter",`BATCH-GET model=${r.model} table=${r.tableName} key=${r.keyField}`,"PLAN",`  -> BATCH-GET keys=${o.length} chunks=${l} estimatedCommands=${l}`].join(`
`))}try{const l=await te({documentClient:e.documentClient,tableName:r.tableName,keyField:r.keyField,keys:o,explainDynamoOperations:e.adapterConfig.explainDynamoOperations}),m=new Map;for(const c of l){const u=c[r.keyField];u!==void 0&&m.set(ve(u),c)}for(const[c,u]of s.entries()){const d=m.get(c)??null;for(const f of u.pending)f.resolve(d)}}catch(l){for(const m of s.values())for(const c of m.pending)c.reject(l)}},i=r=>{r.scheduled||(r.scheduled=!0,queueMicrotask(()=>{a(r)}))};return{load:async r=>{const s=n(r.model),o=ve(r.key);return new Promise((l,m)=>{const c=s.pendingByToken.get(o);if(c){c.pending.push({resolve:l,reject:m});return}s.pendingByToken.set(o,{key:r.key,pending:[{resolve:l,reject:m}]}),i(s)})}}},Kn=e=>{if(!e)throw new b("MISSING_CLIENT","DynamoDB adapter requires a DynamoDBDocumentClient instance.");return e},Ae=e=>{const{documentClient:t,adapterConfig:n,transactionState:a}=e;return({getFieldName:i,getDefaultModelName:r})=>{const s={documentClient:t},o=Pn({documentClient:t,adapterConfig:n,getFieldName:i,getDefaultModelName:r}),l={adapterConfig:n,getFieldName:i,getDefaultModelName:r},m=l,c={...l,transactionState:a},u={...l,transactionState:a};return{create:dn(s,{adapterConfig:n,getDefaultModelName:r,transactionState:a}),findOne:xn(s,{...l,primaryKeyLoader:o,transactionState:a}),findMany:bn(s,l),count:on(s,m),update:kn(s,c),updateMany:pn(s,c),delete:fn(s,u),deleteMany:mn(s,u),createSchema:async f=>({code:Ze({tables:f.tables,file:f.file,tableNamePrefix:n.tableNamePrefix}),path:f.file??"dynamodb-tables.ts",overwrite:!0})}}},Mn=e=>{if(!e.indexNameResolver)throw new b("MISSING_INDEX_RESOLVER","DynamoDB adapter requires indexNameResolver.");const t={documentClient:e.documentClient,debugLogs:e.debugLogs,usePlural:e.usePlural??!1,tableNamePrefix:e.tableNamePrefix,tableNameResolver:e.tableNameResolver,scanMaxPages:e.scanMaxPages,scanPageLimitMode:e.scanPageLimitMode??"throw",explainQueryPlans:e.explainQueryPlans??!1,explainDynamoOperations:e.explainDynamoOperations??!1,indexNameResolver:e.indexNameResolver,indexKeySchemaResolver:e.indexKeySchemaResolver,transaction:e.transaction??!1},n=Kn(t.documentClient),a={value:null},i={config:{adapterId:"dynamodb-adapter",adapterName:"DynamoDB Adapter",usePlural:t.usePlural,debugLogs:t.debugLogs??!1,supportsArrays:!0,supportsJSON:!0,supportsUUIDs:!1,supportsNumericIds:!1,supportsDates:!1,customIdGenerator:e.customIdGenerator??(()=>Qe.randomUUID()),disableIdGeneration:e.disableIdGeneration,mapKeysTransformInput:e.mapKeysTransformInput,mapKeysTransformOutput:e.mapKeysTransformOutput,customTransformInput:e.customTransformInput,customTransformOutput:e.customTransformOutput,transaction:!1},adapter:Ae({documentClient:n,adapterConfig:t})};t.transaction&&(i.config.transaction=async s=>{const o=a.value;if(!o)throw new b("MISSING_CLIENT","DynamoDB adapter options are not initialized.");const l=ln(),m=ue.createAdapterFactory({config:{...i.config,transaction:!1},adapter:Ae({documentClient:n,adapterConfig:t,transactionState:l})})(o),c=await s(m);return await cn({documentClient:n,state:l}),c});const r=ue.createAdapterFactory(i);return s=>(a.value=s,r(s))},W=async e=>{e<=0||await new Promise(t=>{setTimeout(()=>t(),e)})},Fn=async e=>{const t=[],n={lastEvaluatedTableName:void 0};for(;;){const a=await e.send(new F.ListTablesCommand({ExclusiveStartTableName:n.lastEvaluatedTableName}));if(t.push(...a.TableNames??[]),n.lastEvaluatedTableName=a.LastEvaluatedTableName,!n.lastEvaluatedTableName)break}return t},Y=async(e,t)=>{const n=await e.send(new F.DescribeTableCommand({TableName:t}));if(!n.Table)throw new b("MISSING_TABLE_SCHEMA",`DescribeTable did not return a Table for ${t}.`);return n.Table},Ce=e=>(e??[]).map(n=>({attributeName:n.AttributeName??"",keyType:n.KeyType??""})).filter(n=>n.attributeName.length>0&&n.keyType.length>0),Te=e=>{const t=e?.ProjectionType??"",n=[...e?.NonKeyAttributes??[]].sort((a,i)=>a.localeCompare(i));return{projectionType:t,nonKeyAttributes:n}},Ie=e=>({read:e?.ReadCapacityUnits,write:e?.WriteCapacityUnits}),On=e=>{const t=Ce(e.existing.KeySchema),n=Ce(e.desired.KeySchema);if(t.length!==n.length)return!1;for(const[o,l]of t.entries()){const m=n[o];if(!m||l.attributeName!==m.attributeName||l.keyType!==m.keyType)return!1}const a=Te(e.existing.Projection),i=Te(e.desired.Projection);if(a.projectionType!==i.projectionType||a.nonKeyAttributes.length!==i.nonKeyAttributes.length)return!1;for(const[o,l]of a.nonKeyAttributes.entries())if(l!==i.nonKeyAttributes[o])return!1;const r=Ie(e.existing.ProvisionedThroughput),s=Ie(e.desired.ProvisionedThroughput);return!(r.read!==s.read||r.write!==s.write)},$n=e=>(e.GlobalSecondaryIndexes??[]).reduce((n,a)=>(n.set(a.IndexName??"",a),n),new Map),Le=e=>(e.attributeDefinitions??[]).reduce((n,a)=>(a.AttributeName&&n.set(a.AttributeName,a),n),new Map),Vn=e=>(e.KeySchema??[]).map(n=>n.AttributeName).filter(n=>typeof n=="string"&&n.length>0),Rn=e=>{const t=Le({attributeDefinitions:e.desiredTableAttributeDefinitions}),n=[],a=Vn(e.index);for(const i of a){const r=e.existing.get(i);if(r){const o=t.get(i);if(o&&o.AttributeType&&r.AttributeType&&o.AttributeType!==r.AttributeType)throw new b("ATTRIBUTE_DEFINITION_MISMATCH",`Attribute type mismatch for ${i}: existing=${r.AttributeType} desired=${o.AttributeType}`);continue}const s=t.get(i);if(!s)throw new b("MISSING_ATTRIBUTE_DEFINITION",`Missing AttributeDefinition for ${i} required by GSI ${e.index.IndexName??"(unknown)"}.`);n.push(s)}return n},je=async e=>{const t=Date.now(),n=Math.max(0,(e.wait.maxWaitTime??60)*1e3),a=Math.max(0,(e.wait.minDelay??2)*1e3),i=e.presentGsiNames??[],r=e.absentGsiNames??[];for(;;){const s=await Y(e.client,e.tableName),o=s.TableStatus??"",m=(s.GlobalSecondaryIndexes??[]).reduce((d,f)=>{const N=f.IndexName??"";return N.length===0||d.set(N,f.IndexStatus??""),d},new Map),c=i.every(d=>m.get(d)==="ACTIVE"),u=r.every(d=>!m.has(d));if(o!=="ACTIVE"){if(Date.now()-t>n)throw new b("TABLE_WAIT_TIMEOUT",`Timed out waiting for table ${e.tableName} to become ready.`);await W(a);continue}if(!c){if(Date.now()-t>n)throw new b("TABLE_WAIT_TIMEOUT",`Timed out waiting for table ${e.tableName} to become ready.`);await W(a);continue}if(!u){if(Date.now()-t>n)throw new b("TABLE_WAIT_TIMEOUT",`Timed out waiting for table ${e.tableName} to become ready.`);await W(a);continue}return}},_n=async e=>{await e.client.send(new F.UpdateTableCommand({TableName:e.tableName,GlobalSecondaryIndexUpdates:[{Delete:{IndexName:e.indexName}}]})),await je({client:e.client,tableName:e.tableName,wait:e.wait,absentGsiNames:[e.indexName]})},we=async e=>{const t=Le({attributeDefinitions:e.existingAttributeDefinitions}),n=Rn({existing:t,desiredTableAttributeDefinitions:e.desiredTableAttributeDefinitions,index:e.index});await e.client.send(new F.UpdateTableCommand({TableName:e.tableName,AttributeDefinitions:n.length>0?n:void 0,GlobalSecondaryIndexUpdates:[{Create:{IndexName:e.index.IndexName,KeySchema:e.index.KeySchema,Projection:e.index.Projection,ProvisionedThroughput:e.index.ProvisionedThroughput}}]})),await je({client:e.client,tableName:e.tableName,wait:e.wait,presentGsiNames:[e.index.IndexName??""].filter(a=>a.length>0)})},Be=async e=>{if(!e.client)throw new b("MISSING_CLIENT","DynamoDB applyTableSchemas requires a DynamoDBClient instance.");const t=e.wait??{maxWaitTime:60,minDelay:2},n=await Fn(e.client),a=[],i=new Set;for(const r of e.tables){const s=r.tableDefinition,o=s.globalSecondaryIndexes??[];if(!n.includes(r.tableName)){await e.client.send(new F.CreateTableCommand({TableName:r.tableName,AttributeDefinitions:s.attributeDefinitions,KeySchema:s.keySchema,BillingMode:s.billingMode,GlobalSecondaryIndexes:s.globalSecondaryIndexes})),await F.waitUntilTableExists({client:e.client,...t},{TableName:r.tableName}),a.push(r.tableName);continue}if(o.length===0)continue;const l=await Y(e.client,r.tableName),m=$n(l);for(const c of o){const u=c.IndexName??"";if(u.length===0)continue;const d=m.get(u);if(!d){await we({client:e.client,tableName:r.tableName,index:c,existingAttributeDefinitions:l.AttributeDefinitions,desiredTableAttributeDefinitions:s.attributeDefinitions,wait:t}),i.add(r.tableName);continue}if(On({existing:d,desired:c}))continue;await _n({client:e.client,tableName:r.tableName,indexName:u,wait:t});const N=await Y(e.client,r.tableName);await we({client:e.client,tableName:r.tableName,index:c,existingAttributeDefinitions:N.AttributeDefinitions,desiredTableAttributeDefinitions:s.attributeDefinitions,wait:t}),i.add(r.tableName)}}return{createdTables:a,updatedTables:Array.from(i.values())}},qn=async e=>(await Be(e)).createdTables,Ge=[{tableName:"user",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"email",AttributeType:"S"},{AttributeName:"username",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"user_email_idx",KeySchema:[{AttributeName:"email",KeyType:"HASH"}],Projection:{ProjectionType:"ALL"}},{IndexName:"user_username_idx",KeySchema:[{AttributeName:"username",KeyType:"HASH"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"user_email_idx",partitionKey:"email"},{indexName:"user_username_idx",partitionKey:"username"}]},{tableName:"session",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"userId",AttributeType:"S"},{AttributeName:"token",AttributeType:"S"},{AttributeName:"createdAt",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"session_userId_idx",KeySchema:[{AttributeName:"userId",KeyType:"HASH"},{AttributeName:"createdAt",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}},{IndexName:"session_token_idx",KeySchema:[{AttributeName:"token",KeyType:"HASH"},{AttributeName:"createdAt",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"session_userId_idx",partitionKey:"userId",sortKey:"createdAt"},{indexName:"session_token_idx",partitionKey:"token",sortKey:"createdAt"}]},{tableName:"account",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"userId",AttributeType:"S"},{AttributeName:"providerId",AttributeType:"S"},{AttributeName:"accountId",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"account_accountId_idx",KeySchema:[{AttributeName:"accountId",KeyType:"HASH"}],Projection:{ProjectionType:"ALL"}},{IndexName:"account_userId_idx",KeySchema:[{AttributeName:"userId",KeyType:"HASH"}],Projection:{ProjectionType:"ALL"}},{IndexName:"account_providerId_accountId_idx",KeySchema:[{AttributeName:"providerId",KeyType:"HASH"},{AttributeName:"accountId",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"account_accountId_idx",partitionKey:"accountId"},{indexName:"account_userId_idx",partitionKey:"userId"},{indexName:"account_providerId_accountId_idx",partitionKey:"providerId",sortKey:"accountId"}]},{tableName:"verification",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"identifier",AttributeType:"S"},{AttributeName:"createdAt",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"verification_identifier_idx",KeySchema:[{AttributeName:"identifier",KeyType:"HASH"},{AttributeName:"createdAt",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"verification_identifier_idx",partitionKey:"identifier",sortKey:"createdAt"}]}],Ln=Ge,jn=e=>{if(e.length===0)throw new Error("index resolver creation requires table schemas.");const t=new Map,n=new Map;for(const a of e)for(const i of a.indexMappings){const r=`${a.tableName}:${i.partitionKey}`;if(t.has(r))throw new Error(`Duplicate partition key mapping for ${a.tableName}.${i.partitionKey}.`);t.set(r,i);const s=`${a.tableName}:${i.indexName}`;if(n.has(s))throw new Error(`Duplicate index name mapping for ${a.tableName}.${i.indexName}.`);n.set(s,i)}return{indexNameResolver:({model:a,field:i})=>t.get(`${a}:${i}`)?.indexName,indexKeySchemaResolver:({model:a,indexName:i})=>{const r=n.get(`${a}:${i}`);if(r)return{partitionKey:r.partitionKey,sortKey:r.sortKey}}}};exports.DynamoDBAdapterError=b;exports.applyTableSchemas=Be;exports.convertToTableSchemas=X;exports.coreTableSchemas=Ge;exports.createIndexResolversFromSchemas=jn;exports.createTables=qn;exports.defaultCompositeIndexes=Ee;exports.defaultSchemaExtensions=pe;exports.dynamodbAdapter=Mn;exports.generateTableSchemas=Je;exports.multiTableSchemas=Ln;
