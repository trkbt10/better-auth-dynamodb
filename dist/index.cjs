"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const J=require("@better-auth/core/db/adapter"),xe=require("node:crypto"),v=require("@aws-sdk/lib-dynamodb"),L=require("@aws-sdk/client-dynamodb");class f extends Error{constructor(t,n){super(n),this.code=t,this.name="DynamoDBAdapterError"}}const re=e=>e?e.toLowerCase():"eq",H=e=>typeof e=="number"&&!Number.isNaN(e),C=e=>typeof e=="string",be=(e,t)=>e instanceof Date&&t instanceof Date?e.getTime()-t.getTime():H(e)&&H(t)?e-t:C(e)&&C(t)?e<t?-1:e>t?1:0:null,ae=e=>Array.isArray(e)?e:[e],M=e=>{const t=e.appendValue(e.value);return`${e.fieldToken} ${e.operator} ${t}`},D=e=>{const t=be(e.fieldValue,e.value);return t===null?!1:e.operator==="gt"?t>0:e.operator==="gte"?t>=0:e.operator==="lt"?t<0:t<=0},z=e=>{const n=ae(e.value).map(r=>e.appendValue(r)),i=`${e.fieldToken} IN (${n.join(", ")})`;return e.negate?`NOT (${i})`:i},Y=e=>{const n=ae(e.value).some(i=>i===e.fieldValue);return e.negate?!n:n},ge=e=>{const t=e.appendValue(e.value);return`contains(${e.fieldToken}, ${t})`},ve=e=>Array.isArray(e.fieldValue)||C(e.fieldValue)&&C(e.value)?e.fieldValue.includes(e.value):!1,he=e=>{const t=e.appendValue(e.value);return`begins_with(${e.fieldToken}, ${t})`},Ae=e=>C(e.fieldValue)&&C(e.value)?e.fieldValue.startsWith(e.value):!1,Ce=e=>C(e.fieldValue)&&C(e.value)?e.fieldValue.endsWith(e.value):!1,Se={eq:{requiresClientFilter:!1,buildFilterExpression:e=>{const t=e.appendValue(e.value);return`${e.fieldToken} = ${t}`},evaluate:e=>e.fieldValue===e.value},ne:{requiresClientFilter:!1,buildFilterExpression:e=>{const t=e.appendValue(e.value);return`${e.fieldToken} <> ${t}`},evaluate:e=>e.fieldValue!==e.value},gt:{requiresClientFilter:!1,buildFilterExpression:e=>M({fieldToken:e.fieldToken,value:e.value,operator:">",appendValue:e.appendValue}),evaluate:e=>D({fieldValue:e.fieldValue,value:e.value,operator:"gt"})},gte:{requiresClientFilter:!1,buildFilterExpression:e=>M({fieldToken:e.fieldToken,value:e.value,operator:">=",appendValue:e.appendValue}),evaluate:e=>D({fieldValue:e.fieldValue,value:e.value,operator:"gte"})},lt:{requiresClientFilter:!1,buildFilterExpression:e=>M({fieldToken:e.fieldToken,value:e.value,operator:"<",appendValue:e.appendValue}),evaluate:e=>D({fieldValue:e.fieldValue,value:e.value,operator:"lt"})},lte:{requiresClientFilter:!1,buildFilterExpression:e=>M({fieldToken:e.fieldToken,value:e.value,operator:"<=",appendValue:e.appendValue}),evaluate:e=>D({fieldValue:e.fieldValue,value:e.value,operator:"lte"})},in:{requiresClientFilter:!1,buildFilterExpression:e=>z({fieldToken:e.fieldToken,value:e.value,appendValue:e.appendValue,negate:!1}),evaluate:e=>Y({fieldValue:e.fieldValue,value:e.value,negate:!1})},not_in:{requiresClientFilter:!1,buildFilterExpression:e=>z({fieldToken:e.fieldToken,value:e.value,appendValue:e.appendValue,negate:!0}),evaluate:e=>Y({fieldValue:e.fieldValue,value:e.value,negate:!0})},contains:{requiresClientFilter:!1,buildFilterExpression:ge,evaluate:ve},starts_with:{requiresClientFilter:!1,buildFilterExpression:he,evaluate:Ae},ends_with:{requiresClientFilter:!0,buildFilterExpression:void 0,evaluate:Ce}},B=e=>{const t=re(e),n=Se[t];if(!n)throw new f("UNSUPPORTED_OPERATOR",`Unsupported operator: ${e}`);return n},se=e=>B(e).requiresClientFilter,G=e=>re(e),Ie=e=>{if(!e)throw new f("MISSING_WHERE_INPUT","normalizeWhere requires explicit props.");const{where:t}=e;if(!t||t.length===0)return[];const n=i=>i&&i.toUpperCase()==="OR"?"OR":"AND";return t.map(i=>{const r=G(i.operator),a=n(i.connector);return{field:i.field,operator:r,value:i.value,connector:a,requiresClientFilter:se(i.operator)}})},oe=e=>e.getFieldName({model:e.model,field:"id"}),Q=e=>e.where.find(t=>t.operator===e.operator&&t.field===e.primaryKeyName),Ee=e=>{for(const t of e.where){if(t.operator!=="eq")continue;const n=e.indexNameResolver({model:e.model,field:t.field});if(n)return{entry:t,indexName:n}}},we=e=>{for(const t of e.where){if(t.operator!=="in"||!Array.isArray(t.value))continue;const n=e.indexNameResolver({model:e.model,field:t.field});if(n)return{entry:t,indexName:n}}},Te=e=>{if(!e)throw new f("MISSING_STRATEGY_INPUT","resolveBaseStrategy requires explicit props.");if(e.hasOrConnector)return{kind:"scan"};const t=oe({model:e.model,getFieldName:e.getFieldName});if(Q({where:e.where,primaryKeyName:t,operator:"eq"}))return{kind:"query",key:"pk"};const i=Ee({where:e.where,model:e.model,indexNameResolver:e.adapterConfig.indexNameResolver});if(i)return{kind:"query",key:"gsi",indexName:i.indexName};const r=we({where:e.where,model:e.model,indexNameResolver:e.adapterConfig.indexNameResolver});if(r)return{kind:"multi-query",indexName:r.indexName,field:r.entry.field};const a=Q({where:e.where,primaryKeyName:t,operator:"in"});return a&&Array.isArray(a.value)?{kind:"batch-get"}:{kind:"scan"}},le=e=>{if(!e)throw new f("MISSING_JOIN_STRATEGY_INPUT","resolveJoinStrategyHint requires explicit props.");const t=oe({model:e.model,getFieldName:e.getFieldName});if(e.joinField===t)return{kind:"query",key:"pk"};const n=e.adapterConfig.indexNameResolver({model:e.model,field:e.joinField});return n?{kind:"query",key:"gsi",indexName:n}:{kind:"scan"}},ke=e=>{if(!e)throw new f("MISSING_JOIN_STRATEGY_INPUT","resolveJoinStrategy requires explicit props.");const t=le({joinField:e.joinField,model:e.model,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig});return t.kind==="query"&&t.key==="pk"&&e.baseValues.length>1?{kind:"batch-get"}:t},Fe=e=>{if(!e)throw new f("MISSING_JOIN_PLAN_INPUT","resolveJoinPlan requires explicit props.");return!e.join||Object.keys(e.join).length===0?[]:Object.entries(e.join).map(([t,n])=>{const i=le({joinField:n.on.to,model:t,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig});return{modelKey:t,model:t,relation:n.relation??"one-to-many",on:n.on,limit:n.limit,select:void 0,strategy:i}})},Ve=e=>{const t=e.where.some(i=>i.connector==="OR"),n=e.where.some(i=>i.requiresClientFilter);return{hasOrConnector:t,hasClientOnlyOperator:n,requiresSelectSupplement:e.requiresSelectSupplement}},pe=e=>{if(e.requiresClientFilter||e.requiresClientSort||e.limit===void 0)return;const t=e.offset??0;return e.limit+t},Ke=e=>{if(e.sortBy)return{field:e.getFieldName({model:e.model,field:e.sortBy.field}),direction:e.sortBy.direction}},Pe=e=>{if(!e.normalizedSort||e.baseStrategy.kind!=="query"||e.baseStrategy.key!=="gsi"||!e.baseStrategy.indexName||!e.adapterConfig.indexKeySchemaResolver)return;const t=e.adapterConfig.indexKeySchemaResolver({model:e.model,indexName:e.baseStrategy.indexName});if(!(!t||!t.sortKey)&&t.sortKey===e.normalizedSort.field)return e.normalizedSort},Me=e=>!(!e.normalizedSort||e.serverSort),De=e=>{if(!e.select||e.select.length===0)return{select:e.select,requiresSelectSupplement:!1};if(e.joins.length===0)return{select:[...e.select],requiresSelectSupplement:!1};const t={select:[...e.select],selectedFields:new Set(e.select.map(i=>e.getFieldName({model:e.model,field:i}))),requiresSelectSupplement:!1},n=e.joins.reduce((i,r)=>i.selectedFields.has(r.on.from)?i:(i.selectedFields.add(r.on.from),i.select.push(r.on.from),{...i,requiresSelectSupplement:!0}),t);return{select:n.select,requiresSelectSupplement:n.requiresSelectSupplement}},F=e=>{if(!e)throw new f("MISSING_QUERY_PLAN_INPUT","buildQueryPlan requires explicit props.");const t=Ie({where:e.where}),n=Fe({join:e.join,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig}),i=De({select:e.select,joins:n,getFieldName:e.getFieldName,model:e.model}),r=Ve({where:t,requiresSelectSupplement:i.requiresSelectSupplement}),a=Te({model:e.model,where:t,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig,hasOrConnector:r.hasOrConnector}),s=n.reduce((x,N)=>(x[N.modelKey]=N.strategy,x),{}),o=r.hasClientOnlyOperator,l=Ke({sortBy:e.sortBy,getFieldName:e.getFieldName,model:e.model}),d=Pe({model:e.model,baseStrategy:a,normalizedSort:l,adapterConfig:e.adapterConfig}),c=Me({normalizedSort:l,serverSort:d}),u={baseStrategy:a,joinStrategies:s,requiresClientFilter:o,requiresClientSort:c,serverSort:d,fetchLimit:pe({limit:e.limit,offset:e.offset,requiresClientFilter:o,requiresClientSort:c})};return{base:{model:e.model,where:t,select:i.select,sort:l,limit:e.limit,offset:e.offset},joins:n,execution:u,constraints:r}},X=e=>{const t=B(e.condition.operator),n=e.item[e.condition.fieldName];return t.evaluate({fieldValue:n,value:e.condition.value})},Re=e=>e.map(t=>({fieldName:t.field,operator:G(t.operator),value:t.value,connector:t.connector})),_e=e=>{const{item:t,conditions:n}=e;if(n.length===0)return!0;const i=n.filter(u=>u.connector==="AND"),r=n.filter(u=>u.connector==="OR"),a=i.map(u=>X({item:t,condition:u})),s=r.map(u=>X({item:t,condition:u})),o=u=>u.length===0?!0:u.every(Boolean),l=u=>u.length===0?!0:u.some(Boolean);return!(!o(a)||!l(s))},qe=e=>{if(!e.where||e.where.length===0)return e.items;const t=Re(e.where);return e.items.filter(n=>_e({item:n,conditions:t}))},Oe=e=>e.requiresClientFilter?qe({items:e.items,where:e.where}):e.items,je=e=>e==="desc"?-1:1,Le=(e,t)=>{if(e.length<=1)return e;const n=je(t.direction),i=r=>r==null;return[...e].sort((r,a)=>{const s=r[t.field],o=a[t.field];return s===o?0:i(s)?1*n:i(o)?-1*n:s>o?1*n:s<o?-1*n:0})},Ue=(e,t)=>t.sortBy?Le(e,{field:t.sortBy.field,direction:t.sortBy.direction}):e,$e=e=>{if(!e.select||e.select.length===0)return e.items;const t=e.select.map(n=>e.getFieldName({model:e.model,field:n}));return e.items.map(n=>{const i=t.reduce((a,s)=>(s in n&&(a[s]=n[s]),a),{}),r=e.joinKeys.reduce((a,s)=>(s in n&&(a[s]=n[s]),a),{});return{...i,...r}})},S=e=>{const{model:t,getDefaultModelName:n,config:i}=e,r=n(t);if(i.tableNameResolver)return i.tableNameResolver(r);if(i.tableNamePrefix!==void 0)return`${i.tableNamePrefix}${r}`;throw new f("MISSING_TABLE_RESOLVER","DynamoDB adapter requires tableNameResolver or tableNamePrefix.")},Be=(e,t,n)=>{const i=`:v${t.index}`;return t.index+=1,n[i]=e,i},Ge=e=>e&&e.toUpperCase()==="OR"?"OR":"AND",We=e=>{for(const t of e)if(se(t.operator))return!0;return!1},Je=e=>{const t=B(e.operator);if(!t.buildFilterExpression)throw new f("UNSUPPORTED_OPERATOR","Filter expression builder is missing.");const n={fieldToken:e.fieldToken,value:e.value,appendValue:i=>Be(i,e.state,e.values)};return t.buildFilterExpression(n)},He=e=>{const{andExpressions:t,orExpressions:n}=e,i=t.join(" AND "),r=n.join(" OR ");if(i&&r)return`(${i}) AND (${r})`;if(i)return i;if(r)return r},T=e=>{const{where:t,model:n,getFieldName:i}=e;if(!t||t.length===0)return{filterExpression:void 0,expressionAttributeNames:{},expressionAttributeValues:{},requiresClientFilter:!1};if(We(t))return{filterExpression:void 0,expressionAttributeNames:{},expressionAttributeValues:{},requiresClientFilter:!0};const r={},a={},s={index:0},o=t.map((u,x)=>{const N=i({model:n,field:u.field}),y=`#f${x}`;r[y]=N;const b=Je({fieldToken:y,operator:u.operator,value:u.value,state:s,values:a});return{connector:Ge(u.connector),expression:b}}),l=o.filter(u=>u.connector==="AND").map(u=>u.expression),d=o.filter(u=>u.connector==="OR").map(u=>u.expression);return{filterExpression:He({andExpressions:l,orExpressions:d}),expressionAttributeNames:r,expressionAttributeValues:a,requiresClientFilter:!1}},R=e=>{const{model:t,where:n,getFieldName:i,indexNameResolver:r,indexKeySchemaResolver:a}=e;if(!n||n.length===0)return null;const s=i({model:t,field:"id"}),o=m=>m&&m.toUpperCase()==="OR"?"OR":"AND",l=n.map(m=>({entry:m,operator:G(m.operator),fieldName:i({model:t,field:m.field}),connector:o(m.connector)}));if(l.some(({connector:m})=>m==="OR"))return null;const c=l.find(({operator:m,fieldName:w})=>m==="eq"&&w===s);if(c){const m=n.filter(w=>w!==c.entry);return{keyConditionExpression:"#pk = :pk",expressionAttributeNames:{"#pk":s},expressionAttributeValues:{":pk":c.entry.value},remainingWhere:m}}const u=l.find(({operator:m,fieldName:w,entry:j})=>m!=="eq"||!r({model:t,field:j.field})?!1:w.length>0);if(!u)return null;const x=r({model:t,field:u.entry.field});if(!x)return null;const N=()=>{if(a)return a({model:t,indexName:x})},y=m=>{if(m)return l.find(({operator:w,fieldName:j})=>w==="eq"&&j===m)},b=m=>m?"#pk = :pk AND #sk = :sk":"#pk = :pk",I=m=>m.sortKey?{"#pk":m.partitionKey,"#sk":m.sortKey}:{"#pk":m.partitionKey},E=m=>m.sortValue===void 0?{":pk":m.partitionValue}:{":pk":m.partitionValue,":sk":m.sortValue},g=N()?.sortKey,h=y(g),p=m=>{if(m)return g},A=m=>{if(m)return m.entry.value},K=n.filter(m=>m!==u.entry&&m!==h?.entry),O=b(!!h),P=I({partitionKey:u.fieldName,sortKey:p(h)}),Ne=E({partitionValue:u.entry.value,sortValue:A(h)});return{keyConditionExpression:O,expressionAttributeNames:P,expressionAttributeValues:Ne,indexName:x,remainingWhere:K}},_=(e,t)=>{t.filterExpression&&(e.FilterExpression=t.filterExpression),Object.keys(t.expressionAttributeNames).length>0&&(e.ExpressionAttributeNames=t.expressionAttributeNames),Object.keys(t.expressionAttributeValues).length>0&&(e.ExpressionAttributeValues=t.expressionAttributeValues)},q=async e=>{const t={token:e.initialToken,pageCount:0};for(;;){e.maxPages!==void 0&&t.pageCount>=e.maxPages&&e.onMaxPages(),t.pageCount+=1;const n=await e.fetchPage(t.token,t.pageCount),i=n.nextToken,r=n.shouldStop===!0;if(t.token=i,r||!t.token)break}},ue=(e,t)=>{if(e===void 0)return;const n=e-t;return n<=0?0:n},U=async e=>{const t=[];return await q({fetchPage:async n=>{const i=ue(e.limit,t.length);if(i===0)return{shouldStop:!0};const r={TableName:e.tableName,KeyConditionExpression:e.keyConditionExpression};e.indexName&&(r.IndexName=e.indexName),_(r,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),n&&(r.ExclusiveStartKey=n),i!==void 0&&(r.Limit=i),e.scanIndexForward!==void 0&&(r.ScanIndexForward=e.scanIndexForward);const a=await e.documentClient.send(new v.QueryCommand(r)),s=a.Items??[];return t.push(...s),{nextToken:a.LastEvaluatedKey??void 0}}}),t},ze=async e=>{const t={count:0};return await q({fetchPage:async n=>{const i={TableName:e.tableName,KeyConditionExpression:e.keyConditionExpression,Select:"COUNT"};e.indexName&&(i.IndexName=e.indexName),_(i,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),n&&(i.ExclusiveStartKey=n);const r=await e.documentClient.send(new v.QueryCommand(i));return t.count+=r.Count??0,{nextToken:r.LastEvaluatedKey??void 0}}}),t.count},de=async e=>{const t=[];return await q({maxPages:e.maxPages??Number.POSITIVE_INFINITY,onMaxPages:()=>{throw new f("SCAN_PAGE_LIMIT","Scan exceeded the configured page limit.")},fetchPage:async n=>{const i=ue(e.limit,t.length);if(i===0)return{shouldStop:!0};const r={TableName:e.tableName};_(r,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),n&&(r.ExclusiveStartKey=n),i!==void 0&&(r.Limit=i);const a=await e.documentClient.send(new v.ScanCommand(r)),s=a.Items??[];return t.push(...s),{nextToken:a.LastEvaluatedKey??void 0}}}),t},Ye=async e=>{const t={count:0};return await q({maxPages:e.maxPages??Number.POSITIVE_INFINITY,onMaxPages:()=>{throw new f("SCAN_PAGE_LIMIT","Scan exceeded the configured page limit.")},fetchPage:async n=>{const i={TableName:e.tableName,Select:"COUNT"};_(i,{filterExpression:e.filterExpression,expressionAttributeNames:e.expressionAttributeNames,expressionAttributeValues:e.expressionAttributeValues}),n&&(i.ExclusiveStartKey=n);const r=await e.documentClient.send(new v.ScanCommand(i));return t.count+=r.Count??0,{nextToken:r.LastEvaluatedKey??void 0}}}),t.count},Qe=(e,t)=>{const n=Math.ceil(e.length/t);return Array.from({length:n},(i,r)=>e.slice(r*t,(r+1)*t))},Xe=(e,t)=>t.map(n=>({[e]:n})),Ze=e=>{const t=e.unprocessed?.[e.tableName]?.Keys;return t||[]},ce=async e=>{if(e.keys.length===0)return[];const t=[],n=Qe(e.keys,100),i=5,r=async(a,s)=>{if(a.length===0)return[];if(s>=i)throw new f("BATCH_GET_UNPROCESSED","Failed to resolve unprocessed keys after retries.");const o=await e.documentClient.send(new v.BatchGetCommand({RequestItems:{[e.tableName]:{Keys:a}}})),l=o.Responses?.[e.tableName]??[],d=Ze({unprocessed:o.UnprocessedKeys,tableName:e.tableName}),c=await r(d,s+1);return[...l,...c]};for(const a of n){const s=Xe(e.keyField,a),o=await r(s,0);t.push(...o)}return t},et=e=>e.relation==="one-to-one"?1:e.limit!==void 0?e.limit:100,tt=e=>{if(!(e.baseValues.length>1))return e.limit},nt=e=>{if(e.adapterConfig.scanMaxPages===void 0)throw new f("MISSING_SCAN_LIMIT","Join scan requires scanMaxPages.");return e.adapterConfig.scanMaxPages},it=e=>{const t=e.items.map(n=>n[e.field]).filter(n=>n!==void 0);return Array.from(new Set(t))},rt=e=>{const t=new Map;for(const n of e.items){const i=n[e.field];if(i===void 0)continue;const r=t.get(i)??[];t.set(i,[...r,n])}return t},at=e=>e==="one-to-one"?null:[],st=(e,t)=>t===void 0?[]:e.get(t)??[],Z=e=>[{field:e.field,operator:e.operator,value:e.value,connector:"AND"}],ot=async e=>{const t=S({model:e.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),n=R({model:e.model,where:e.where,getFieldName:e.getFieldName,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(!n)throw new f("MISSING_KEY_CONDITION","Join query requires a key condition.");const i=T({model:e.model,where:n.remainingWhere,getFieldName:e.getFieldName});return await U({documentClient:e.documentClient,tableName:t,indexName:n.indexName,keyConditionExpression:n.keyConditionExpression,filterExpression:i.filterExpression,expressionAttributeNames:{...n.expressionAttributeNames,...i.expressionAttributeNames},expressionAttributeValues:{...n.expressionAttributeValues,...i.expressionAttributeValues},limit:e.limit})},lt=async e=>{const t=S({model:e.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),n=T({model:e.model,where:e.where,getFieldName:e.getFieldName});return await de({documentClient:e.documentClient,tableName:t,filterExpression:n.filterExpression,expressionAttributeNames:n.expressionAttributeNames,expressionAttributeValues:n.expressionAttributeValues,limit:e.limit,maxPages:e.maxPages})},ut=async e=>{if(!e)throw new f("MISSING_JOIN_EXECUTION_INPUT","executeJoin requires explicit props.");const t=it({items:e.baseItems,field:e.join.on.from});if(t.length===0)return e.baseItems.map(l=>({...l,[e.join.modelKey]:at(e.join.relation)}));const n=ke({joinField:e.join.on.to,model:e.join.model,baseValues:t,getFieldName:e.getFieldName,adapterConfig:e.adapterConfig}),i=et({relation:e.join.relation,limit:e.join.limit}),a=await(async()=>{if(n.kind==="batch-get"){const u=e.join.on.to;return ce({documentClient:e.documentClient,tableName:S({model:e.join.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),keyField:u,keys:t})}if(n.kind==="query"){const u=Promise.resolve([]);return t.reduce(async(x,N)=>{const y=await x,b=Z({field:e.join.on.to,operator:"eq",value:N}),I=await ot({documentClient:e.documentClient,adapterConfig:e.adapterConfig,model:e.join.model,where:b,limit:i,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName});return[...y,...I]},u)}const l=Z({field:e.join.on.to,operator:"in",value:t}),d=nt({adapterConfig:e.adapterConfig}),c=tt({limit:i,baseValues:t});return lt({documentClient:e.documentClient,adapterConfig:e.adapterConfig,model:e.join.model,where:l,limit:c,maxPages:d,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName})})(),s=rt({items:a,field:e.join.on.to}),o=l=>e.join.relation==="one-to-one"?l[0]??null:l.slice(0,i);return e.baseItems.map(l=>{const d=l[e.join.on.from],c=st(s,d),u=o(c);return{...l,[e.join.modelKey]:u}})},dt=e=>e.strategy.kind==="batch-get"?!0:e.requiresClientFilter,ct=e=>{if(e.serverSort)return e.serverSort.direction==="asc"},mt=e=>e.strategy.kind!=="query"?e.keyConditionIndex:e.strategy.key==="gsi"?e.strategy.indexName:e.keyConditionIndex,ft=e=>e.serverSort?e.items:Ue(e.items,{sortBy:e.sort}),yt=e=>{if(e.adapterConfig.scanMaxPages===void 0)throw new f("MISSING_SCAN_LIMIT","Scan execution requires scanMaxPages.");return e.adapterConfig.scanMaxPages},Nt=e=>e.map(t=>({field:t.field,operator:t.operator,value:t.value,connector:t.connector})),xt=e=>{const t=e.where.find(n=>n.field===e.primaryKeyName&&n.operator==="in");return t?Array.isArray(t.value)?t.value:[]:[]},bt=async e=>{const t=Nt(e.plan.base.where),n=S({model:e.plan.base.model,getDefaultModelName:e.getDefaultModelName,config:e.adapterConfig}),i=e.plan.execution.baseStrategy;if(i.kind==="batch-get"){const s=e.getFieldName({model:e.plan.base.model,field:"id"}),o=xt({where:e.plan.base.where,primaryKeyName:s});return o.length===0?[]:ce({documentClient:e.documentClient,tableName:n,keyField:s,keys:o})}if(i.kind==="multi-query"){const s=e.plan.base.where.find(u=>u.field===i.field&&u.operator==="in");if(!s)return[];if(!Array.isArray(s.value))return[];const o=s.value,l=e.plan.execution.fetchLimit,d=e.plan.base.model;return(await Promise.all(o.map(async u=>{const x=t.map(b=>b.field===i.field&&b.operator==="in"?{...b,operator:"eq",value:u}:b),N=R({model:d,where:x,getFieldName:e.getFieldName,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(!N)return[];const y=T({model:d,where:N.remainingWhere,getFieldName:e.getFieldName});return await U({documentClient:e.documentClient,tableName:n,indexName:N.indexName??i.indexName,keyConditionExpression:N.keyConditionExpression,filterExpression:y.filterExpression,expressionAttributeNames:{...N.expressionAttributeNames,...y.expressionAttributeNames},expressionAttributeValues:{...N.expressionAttributeValues,...y.expressionAttributeValues},limit:l})}))).flat()}if(i.kind==="query"){const s=R({model:e.plan.base.model,where:t,getFieldName:e.getFieldName,indexNameResolver:e.adapterConfig.indexNameResolver,indexKeySchemaResolver:e.adapterConfig.indexKeySchemaResolver});if(!s)throw new f("MISSING_KEY_CONDITION","Query strategy requires a key condition.");const o=T({model:e.plan.base.model,where:s.remainingWhere,getFieldName:e.getFieldName}),l=mt({strategy:i,keyConditionIndex:s.indexName}),d=ct({serverSort:e.plan.execution.serverSort});return await U({documentClient:e.documentClient,tableName:n,indexName:l,keyConditionExpression:s.keyConditionExpression,filterExpression:o.filterExpression,expressionAttributeNames:{...s.expressionAttributeNames,...o.expressionAttributeNames},expressionAttributeValues:{...s.expressionAttributeValues,...o.expressionAttributeValues},limit:e.plan.execution.fetchLimit,scanIndexForward:d})}const r=T({model:e.plan.base.model,where:t,getFieldName:e.getFieldName}),a=yt({adapterConfig:e.adapterConfig});return await de({documentClient:e.documentClient,tableName:n,filterExpression:r.filterExpression,expressionAttributeNames:r.expressionAttributeNames,expressionAttributeValues:r.expressionAttributeValues,limit:e.plan.execution.fetchLimit,maxPages:a})},gt=e=>{const t=e.offset??0;return e.limit===void 0?e.items.slice(t):e.items.slice(t,t+e.limit)},k=e=>{if(!e)throw new f("MISSING_EXECUTOR_INPUT","createQueryPlanExecutor requires explicit props.");return async t=>{const n=await bt({plan:t,documentClient:e.documentClient,adapterConfig:e.adapterConfig,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName}),i=dt({strategy:t.execution.baseStrategy,requiresClientFilter:t.execution.requiresClientFilter}),r=Oe({items:n,where:t.base.where,requiresClientFilter:i}),a=ft({items:r,serverSort:t.execution.serverSort,sort:t.base.sort}),s=gt({items:a,offset:t.base.offset,limit:t.base.limit}),l=await t.joins.reduce(async(u,x)=>{const N=await u;return ut({baseItems:N,join:x,documentClient:e.documentClient,adapterConfig:e.adapterConfig,getFieldName:e.getFieldName,getDefaultModelName:e.getDefaultModelName})},Promise.resolve(s)),d=t.joins.map(u=>u.modelKey);return $e({items:l,model:t.base.model,select:t.base.select,joinKeys:d,getFieldName:e.getFieldName})}},vt=(e,t)=>{const{documentClient:n}=e,{adapterConfig:i,getFieldName:r,getDefaultModelName:a}=t,s=()=>{if(i.scanMaxPages===void 0)throw new f("MISSING_SCAN_LIMIT","Count scan requires scanMaxPages.");return i.scanMaxPages};return async({model:o,where:l})=>{const d=F({model:o,where:l,select:void 0,sortBy:void 0,limit:void 0,offset:void 0,join:void 0,getFieldName:r,adapterConfig:i});if(d.execution.requiresClientFilter)return(await k({documentClient:n,adapterConfig:i,getFieldName:r,getDefaultModelName:a})(d)).length;if(d.execution.baseStrategy.kind==="batch-get")return(await k({documentClient:n,adapterConfig:i,getFieldName:r,getDefaultModelName:a})(d)).length;const c=S({model:o,getDefaultModelName:a,config:i}),u=d.base.where.map(y=>({field:y.field,operator:y.operator,value:y.value,connector:y.connector}));if(d.execution.baseStrategy.kind==="query"){const y=R({model:o,where:u,getFieldName:r,indexNameResolver:i.indexNameResolver,indexKeySchemaResolver:i.indexKeySchemaResolver});if(!y)throw new f("MISSING_KEY_CONDITION","Count query requires a key condition.");const b=T({model:o,where:y.remainingWhere,getFieldName:r});return ze({documentClient:n,tableName:c,indexName:y.indexName,keyConditionExpression:y.keyConditionExpression,filterExpression:b.filterExpression,expressionAttributeNames:{...y.expressionAttributeNames,...b.expressionAttributeNames},expressionAttributeValues:{...y.expressionAttributeValues,...b.expressionAttributeValues}})}const x=T({model:o,where:u,getFieldName:r}),N=s();return Ye({documentClient:n,tableName:c,filterExpression:x.filterExpression,expressionAttributeNames:x.expressionAttributeNames,expressionAttributeValues:x.expressionAttributeValues,maxPages:N})}},ht=()=>({operations:[]}),W=(e,t)=>{if(e.operations.length>=25)throw new f("TRANSACTION_LIMIT","DynamoDB transactions are limited to 25 operations.");e.operations.push(t)},At=e=>e.kind==="put"?{Put:{TableName:e.tableName,Item:e.item}}:e.kind==="update"?{Update:{TableName:e.tableName,Key:e.key,UpdateExpression:e.updateExpression,ExpressionAttributeNames:e.expressionAttributeNames,ExpressionAttributeValues:e.expressionAttributeValues}}:{Delete:{TableName:e.tableName,Key:e.key}},Ct=async e=>{const{documentClient:t,state:n}=e;if(n.operations.length===0)return;const i=n.operations.map(r=>At(r));await t.send(new v.TransactWriteCommand({TransactItems:i}))},St=(e,t)=>{const{documentClient:n}=e,{adapterConfig:i,getDefaultModelName:r,transactionState:a}=t,s=o=>S({model:o,getDefaultModelName:r,config:i});return async({model:o,data:l})=>{const d=s(o);return a?(W(a,{kind:"put",tableName:d,item:l}),l):(await n.send(new v.PutCommand({TableName:d,Item:l})),l)}},me=e=>{const{item:t,keyField:n}=e;if(!(n in t))throw new f("MISSING_PRIMARY_KEY",`Item is missing primary key field "${n}".`);return{[n]:t[n]}},fe=(e,t)=>{const{documentClient:n}=e,{adapterConfig:i,getFieldName:r,getDefaultModelName:a,transactionState:s}=t,o=k({documentClient:n,adapterConfig:i,getFieldName:r,getDefaultModelName:a}),l=c=>S({model:c,getDefaultModelName:a,config:i}),d=c=>r({model:c,field:"id"});return async({model:c,where:u,limit:x})=>{const N=l(c),y=F({model:c,where:u,select:void 0,sortBy:void 0,limit:x,offset:void 0,join:void 0,getFieldName:r,adapterConfig:i}),b=await o(y);if(b.length===0)return 0;const I=d(c),E={deleted:0};for(const V of b){const g=me({item:V,keyField:I});s?W(s,{kind:"delete",tableName:N,key:g}):await n.send(new v.DeleteCommand({TableName:N,Key:g})),E.deleted+=1}return E.deleted}},It=(e,t)=>{const n=fe(e,t);return async({model:i,where:r})=>n({model:i,where:r})},Et=(e,t)=>{const n=fe(e,t);return async({model:i,where:r})=>{await n({model:i,where:r,limit:1})}},wt=(e,t)=>{const{documentClient:n}=e,{adapterConfig:i,getFieldName:r,getDefaultModelName:a}=t,s=k({documentClient:n,adapterConfig:i,getFieldName:r,getDefaultModelName:a});return async({model:o,where:l,limit:d,sortBy:c,offset:u,join:x})=>{const N=F({model:o,where:l,select:void 0,sortBy:c,limit:d,offset:u,join:x,getFieldName:r,adapterConfig:i});return s(N)}},Tt=(e,t)=>{const n=wt(e,t);return async i=>await n(i)},kt=(e,t)=>{const n=k({documentClient:e.documentClient,adapterConfig:t.adapterConfig,getFieldName:t.getFieldName,getDefaultModelName:t.getDefaultModelName});return async({model:i,where:r,select:a,join:s})=>{const o=F({model:i,where:r,select:a,sortBy:void 0,limit:1,offset:0,join:s,getFieldName:t.getFieldName,adapterConfig:t.adapterConfig}),l=await n(o);return l.length===0?null:l[0]}},ee=e=>e!==null&&typeof e=="object"&&!Array.isArray(e),$=(e,t,n)=>{if(Object.is(t,n))return[];if(typeof t!=typeof n)return[{path:e,prev:t,next:n}];if(Array.isArray(t)&&Array.isArray(n)){const i=Math.max(t.length,n.length);return Array.from({length:i},(r,a)=>{const s=t[a],o=n[a];return $([...e,a],s,o)}).flat()}if(ee(t)&&ee(n)){const i=new Set([...Object.keys(t),...Object.keys(n)]);return Array.from(i).flatMap(r=>$([...e,r],t[r],n[r]))}return[{path:e,prev:t,next:n}]},te=e=>{const t=new Map,n={value:0};return i=>{const r=t.get(i);if(r)return r;const a=`${e}${n.value}`;return n.value+=1,t.set(i,a),a}},Ft=(e,t)=>typeof e<"u"&&typeof t>"u",Vt=(e,t)=>typeof e=="number"&&typeof t=="number",pt=(e,t)=>typeof e!=typeof t,Kt=(e,t)=>typeof e==typeof t,ne=e=>{if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{throw new f("INVALID_UPDATE","Failed to serialize update value.")}},Pt=e=>{if(Object.is(e.prev,e.next))return{kind:"noop",expression:"",attributeNames:{},attributeValues:{}};const t=e.path.filter(o=>typeof o=="string"),n=t.map(o=>e.makeNameKey(o)),i=o=>o===""?"":".",r=e.path.reduce((o,l)=>{if(typeof l=="number")return`${o}[${l}]`;const d=i(o);return`${o}${d}#${e.makeNameKey(l)}`},""),a=n.map((o,l)=>[`#${o}`,t[l].toString()]),s=Object.fromEntries(a);if(Ft(e.prev,e.next))return{kind:"remove",expression:r,attributeNames:s,attributeValues:{}};if(Vt(e.prev,e.next)){const o=e.next-e.prev,l=e.makeValueKey(ne(o));return{kind:"add",expression:`${r} :${l}`,attributeNames:s,attributeValues:{[`:${l}`]:o}}}if(Kt(e.prev,e.next)||pt(e.prev,e.next)){const o=e.makeValueKey(ne(e.next));return{kind:"set",expression:`${r} = :${o}`,attributeNames:s,attributeValues:{[`:${o}`]:e.next}}}return{kind:"noop",expression:"",attributeNames:{},attributeValues:{}}},Mt=e=>{const t=e.reduce((i,r)=>{const a=i[r.kind]??[];return i[r.kind]=[...a,r],i},{}),n=Object.entries(t).reduce((i,[r,a])=>{if(r==="noop")return i;const s=a.map(o=>o.expression).join(",");return{updateExpression:[...i.updateExpression,`${r.toUpperCase()} ${s}`],attributeNames:a.reduce((o,l)=>({...o,...l.attributeNames}),i.attributeNames),attributeValues:a.reduce((o,l)=>({...o,...l.attributeValues}),i.attributeValues)}},{updateExpression:[],attributeNames:{},attributeValues:{}});return{updateExpression:n.updateExpression.join(" "),attributeNames:n.attributeNames,attributeValues:n.attributeValues}},Dt=e=>{if(!e)throw new f("INVALID_UPDATE","Patch update requires explicit prev/next.");const t=$([],e.prev,e.next);if(t.length===0)throw new f("INVALID_UPDATE","Update payload must include at least one defined value.");const n=te("a"),i=te("v"),r=t.map(s=>Pt({...s,makeNameKey:n,makeValueKey:i})),a=Mt(r);if(!a.updateExpression)throw new f("INVALID_UPDATE","Update payload must include at least one defined value.");return{updateExpression:a.updateExpression,expressionAttributeNames:a.attributeNames,expressionAttributeValues:a.attributeValues}},Rt=(e,t)=>Object.entries(t).reduce((n,[i,r])=>({...n,[i]:r}),{...e}),_t=e=>Object.entries(e).reduce((n,[i,r])=>r===void 0?n:{...n,[i]:r},{}),qt=e=>e?{ReturnValues:"ALL_NEW"}:{},ye=(e,t)=>{const{documentClient:n}=e,{adapterConfig:i,getFieldName:r,getDefaultModelName:a,transactionState:s}=t,o=k({documentClient:n,adapterConfig:i,getFieldName:r,getDefaultModelName:a}),l=c=>S({model:c,getDefaultModelName:a,config:i}),d=c=>r({model:c,field:"id"});return async({model:c,where:u,update:x,limit:N,returnUpdatedItems:y})=>{const b=l(c),I=F({model:c,where:u,select:void 0,sortBy:void 0,limit:N,offset:void 0,join:void 0,getFieldName:r,adapterConfig:i}),E=await o(I);if(E.length===0)return{updatedCount:0,updatedItems:[]};const V=d(c),g={updatedCount:0,updatedItems:[]};for(const h of E){const p=Rt(h,x),A=Dt({prev:h,next:p}),K=me({item:h,keyField:V});if(s)W(s,{kind:"update",tableName:b,key:K,updateExpression:A.updateExpression,expressionAttributeNames:A.expressionAttributeNames,expressionAttributeValues:A.expressionAttributeValues}),y&&g.updatedItems.push(_t(p));else{const O={TableName:b,Key:K,UpdateExpression:A.updateExpression,ExpressionAttributeNames:A.expressionAttributeNames,ExpressionAttributeValues:A.expressionAttributeValues,...qt(y)},P=await n.send(new v.UpdateCommand(O));y&&P.Attributes&&g.updatedItems.push(P.Attributes)}g.updatedCount+=1}return g}},Ot=(e,t)=>{const n=ye(e,t);return async({model:i,where:r,update:a})=>(await n({model:i,where:r,update:a,returnUpdatedItems:!1})).updatedCount},jt=(e,t)=>{const n=ye(e,t);return async({model:i,where:r,update:a})=>{const s=await n({model:i,where:r,update:a,limit:1,returnUpdatedItems:!0});return s.updatedItems.length===0?null:s.updatedItems[0]}},Lt=e=>{if(!e)throw new f("MISSING_CLIENT","DynamoDB adapter requires a DynamoDBDocumentClient instance.");return e},ie=e=>{const{documentClient:t,adapterConfig:n,transactionState:i}=e;return({getFieldName:r,getDefaultModelName:a})=>{const s={documentClient:t},o={adapterConfig:n,getFieldName:r,getDefaultModelName:a},l=o,d={...o,transactionState:i},c={...o,transactionState:i};return{create:St(s,{adapterConfig:n,getDefaultModelName:a,transactionState:i}),findOne:kt(s,o),findMany:Tt(s,o),count:vt(s,l),update:jt(s,d),updateMany:Ot(s,d),delete:Et(s,c),deleteMany:It(s,c)}}},Ut=e=>{if(!e.indexNameResolver)throw new f("MISSING_INDEX_RESOLVER","DynamoDB adapter requires indexNameResolver.");const t={documentClient:e.documentClient,debugLogs:e.debugLogs,usePlural:e.usePlural??!1,tableNamePrefix:e.tableNamePrefix,tableNameResolver:e.tableNameResolver,scanMaxPages:e.scanMaxPages,indexNameResolver:e.indexNameResolver,indexKeySchemaResolver:e.indexKeySchemaResolver,transaction:e.transaction??!1},n=Lt(t.documentClient),i={value:null},r={config:{adapterId:"dynamodb-adapter",adapterName:"DynamoDB Adapter",usePlural:t.usePlural,debugLogs:t.debugLogs??!1,supportsArrays:!0,supportsJSON:!0,supportsUUIDs:!1,supportsNumericIds:!1,supportsDates:!1,customIdGenerator:e.customIdGenerator??(()=>xe.randomUUID()),disableIdGeneration:e.disableIdGeneration,mapKeysTransformInput:e.mapKeysTransformInput,mapKeysTransformOutput:e.mapKeysTransformOutput,customTransformInput:e.customTransformInput,customTransformOutput:e.customTransformOutput,transaction:!1},adapter:ie({documentClient:n,adapterConfig:t})};t.transaction&&(r.config.transaction=async s=>{const o=i.value;if(!o)throw new f("MISSING_CLIENT","DynamoDB adapter options are not initialized.");const l=ht(),d=J.createAdapterFactory({config:{...r.config,transaction:!1},adapter:ie({documentClient:n,adapterConfig:t,transactionState:l})})(o),c=await s(d);return await Ct({documentClient:n,state:l}),c});const a=J.createAdapterFactory(r);return s=>(i.value=s,a(s))},$t=async e=>{const t=[],n={lastEvaluatedTableName:void 0};for(;;){const i=await e.send(new L.ListTablesCommand({ExclusiveStartTableName:n.lastEvaluatedTableName}));if(t.push(...i.TableNames??[]),n.lastEvaluatedTableName=i.LastEvaluatedTableName,!n.lastEvaluatedTableName)break}return t},Bt=async e=>{if(!e.client)throw new f("MISSING_CLIENT","DynamoDB createTables requires a DynamoDBClient instance.");const t=await $t(e.client),n=e.wait??{maxWaitTime:60,minDelay:2},i=[];for(const r of e.tables){if(t.includes(r.tableName))continue;const a=r.tableDefinition;await e.client.send(new L.CreateTableCommand({TableName:r.tableName,AttributeDefinitions:a.attributeDefinitions,KeySchema:a.keySchema,BillingMode:a.billingMode,GlobalSecondaryIndexes:a.globalSecondaryIndexes})),await L.waitUntilTableExists({client:e.client,...n},{TableName:r.tableName}),i.push(r.tableName)}return i},Gt=e=>{if(e.length===0)throw new Error("index resolver creation requires table schemas.");const t=new Map,n=new Map;for(const i of e)for(const r of i.indexMappings){const a=`${i.tableName}:${r.partitionKey}`;if(t.has(a))throw new Error(`Duplicate partition key mapping for ${i.tableName}.${r.partitionKey}.`);t.set(a,r);const s=`${i.tableName}:${r.indexName}`;if(n.has(s))throw new Error(`Duplicate index name mapping for ${i.tableName}.${r.indexName}.`);n.set(s,r)}return{indexNameResolver:({model:i,field:r})=>t.get(`${i}:${r}`)?.indexName,indexKeySchemaResolver:({model:i,indexName:r})=>{const a=n.get(`${i}:${r}`);if(a)return{partitionKey:a.partitionKey,sortKey:a.sortKey}}}},Wt=[{tableName:"user",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST"},indexMappings:[]},{tableName:"session",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"userId",AttributeType:"S"},{AttributeName:"token",AttributeType:"S"},{AttributeName:"createdAt",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"session_userId_idx",KeySchema:[{AttributeName:"userId",KeyType:"HASH"},{AttributeName:"createdAt",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}},{IndexName:"session_token_idx",KeySchema:[{AttributeName:"token",KeyType:"HASH"},{AttributeName:"createdAt",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"session_userId_idx",partitionKey:"userId",sortKey:"createdAt"},{indexName:"session_token_idx",partitionKey:"token",sortKey:"createdAt"}]},{tableName:"account",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"userId",AttributeType:"S"},{AttributeName:"providerId",AttributeType:"S"},{AttributeName:"accountId",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"account_userId_idx",KeySchema:[{AttributeName:"userId",KeyType:"HASH"}],Projection:{ProjectionType:"ALL"}},{IndexName:"account_providerId_accountId_idx",KeySchema:[{AttributeName:"providerId",KeyType:"HASH"},{AttributeName:"accountId",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"account_userId_idx",partitionKey:"userId"},{indexName:"account_providerId_accountId_idx",partitionKey:"providerId",sortKey:"accountId"}]},{tableName:"verification",tableDefinition:{attributeDefinitions:[{AttributeName:"id",AttributeType:"S"},{AttributeName:"identifier",AttributeType:"S"},{AttributeName:"createdAt",AttributeType:"S"}],keySchema:[{AttributeName:"id",KeyType:"HASH"}],billingMode:"PAY_PER_REQUEST",globalSecondaryIndexes:[{IndexName:"verification_identifier_idx",KeySchema:[{AttributeName:"identifier",KeyType:"HASH"},{AttributeName:"createdAt",KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}]},indexMappings:[{indexName:"verification_identifier_idx",partitionKey:"identifier",sortKey:"createdAt"}]}];exports.DynamoDBAdapterError=f;exports.createIndexResolversFromSchemas=Gt;exports.createTables=Bt;exports.dynamodbAdapter=Ut;exports.multiTableSchemas=Wt;
